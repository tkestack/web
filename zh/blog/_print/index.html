<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><link rel=canonical type=text/html href=/web/zh/blog/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/web/favicons/favicon.ico><link rel=apple-touch-icon href=/web/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/web/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/web/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/web/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/web/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/web/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/web/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/web/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/web/favicons/android-192x192.png sizes=192x192><title>TKEStack åšå®¢ | Tkestack</title><meta name=description content="ç”Ÿäº§çº§åˆ«å¤šé›†ç¾¤ç®¡ç†ç³»ç»Ÿ"><meta property="og:title" content="TKEStack åšå®¢"><meta property="og:description" content="ç”Ÿäº§çº§åˆ«å¤šé›†ç¾¤ç®¡ç†ç³»ç»Ÿ"><meta property="og:type" content="website"><meta property="og:url" content="/web/zh/blog/"><meta property="og:site_name" content="Tkestack"><meta itemprop=name content="TKEStack åšå®¢"><meta itemprop=description content="ç”Ÿäº§çº§åˆ«å¤šé›†ç¾¤ç®¡ç†ç³»ç»Ÿ"><meta name=twitter:card content="summary"><meta name=twitter:title content="TKEStack åšå®¢"><meta name=twitter:description content="ç”Ÿäº§çº§åˆ«å¤šé›†ç¾¤ç®¡ç†ç³»ç»Ÿ"><link rel=preload href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css as=style><link href=/web/scss/main.min.f3f5e11928ea652eef8f11ab959efa477bbd1a85923ff5e0245c83fe74bd312a.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class="td-section td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/web/zh/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Tkestack</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/docs/><span>Docs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/web/zh/blog/><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>ä¸­æ–‡ Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/web/blog/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>è¿™æ˜¯æœ¬èŠ‚çš„å¤šé¡µæ‰“å°è§†å›¾ã€‚
<a href=# onclick="return print(),!1">ç‚¹å‡»æ­¤å¤„æ‰“å°</a>.</p><p><a href=/web/zh/blog/>è¿”å›æœ¬é¡µå¸¸è§„è§†å›¾</a>.</p></div><h1 class=title>TKEStack åšå®¢</h1><ul><li><a href=#pg-bd76b7deb8c0aa680cf9a657e24d4fc0>TKEStack å®¹å™¨æ··åˆäº‘èƒ½åŠ›ä»‹ç»ï¼ˆ2ï¼‰ï¼šæ‰“ç ´ç½‘ç»œè¾¹ç•Œ</a></li><li><a href=#pg-0b6f95117da45acb1ad27804dd0b465c>TKEStack ä¸­çš„è®¤è¯ä¸é‰´æƒ</a></li><li><a href=#pg-94a52bb4e5649acbc639e6f5ab3e615f>TKEStack é›†ç¾¤å®¹å™¨è¿è¡Œæ—¶è¿ç§»</a></li><li><a href=#pg-bdcc72ec4f0032b1d49860cf2520f4b3>TKEStack å®¹å™¨æ··åˆäº‘èƒ½åŠ›ä»‹ç»ï¼ˆ1ï¼‰ï¼šç»Ÿä¸€åŸºçŸ³</a></li><li><a href=#pg-89581b78a6814df37de4a78cba3ec27f>è…¾è®¯å¼€æºå®¹å™¨äº‘å¹³å° TKEStack ä»‹ç»</a></li></ul><div class=content><p>This is the <strong>blog</strong> section.</p></div></div><div class=td-content><h1 id=pg-bd76b7deb8c0aa680cf9a657e24d4fc0>TKEStack å®¹å™¨æ··åˆäº‘èƒ½åŠ›ä»‹ç»ï¼ˆ2ï¼‰ï¼šæ‰“ç ´ç½‘ç»œè¾¹ç•Œ</h1><div class="td-byline mb-4"><time datetime=2021-12-20 class=text-muted>2021.12.20</time></div><p><strong>Author</strong>: LeoRyu</p><p><em>TKEStack æä¾›äº†å¤šé›†ç¾¤ç®¡ç†èƒ½åŠ›ï¼Œå…¶ä¸­å¯¼å…¥é›†ç¾¤åŠŸèƒ½é€šè¿‡æ¨é€æ¨¡å¼ç”± TKEStack ç®¡æ§é›†ç¾¤ï¼ˆglobal clusterï¼‰ç›´è¿ç¬¬ä¸‰æ–¹é›†ç¾¤çš„ api-server è¿›è€Œç»Ÿä¸€çº³ç®¡éƒ¨ç½²åœ¨ IDCï¼Œå…¬æœ‰äº‘æˆ–è¾¹ç¼˜çš„ç¬¬ä¸‰æ–¹é›†ç¾¤ã€‚ ä½†åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ ç®¡æ§é›†ç¾¤å’Œç¬¬ä¸‰æ–¹é›†ç¾¤ä¹‹é—´çš„ç›´è¿å¾€å¾€ä¼šå‡ºç°å¾ˆå¤šé˜»ç¢ï¼šæˆ–æ˜¯ä¸åœ¨åŒä¸€ä¸ªäºŒå±‚ç½‘ç»œä¸‹ï¼Œæˆ–æ˜¯ç¬¬ä¸‰æ–¹é›†ç¾¤åœ¨é˜²ç«å¢™/NATä¹‹åï¼Œæˆ–æ˜¯ç¬¬ä¸‰æ–¹é›†ç¾¤åœ¨ç½‘ç»œç­–ç•¥ä¸Šä¸å…è®¸æœ‰å…¥ç«™ç½‘ç»œä¼ è¾“ï¼Œåœ¨è¿™äº›åœºæ™¯ä¸‹, TKEStackéš¾ä»¥ç›´è¿ç¬¬ä¸‰æ–¹é›†ç¾¤ api-server, å¯¼å…¥é›†ç¾¤çš„èƒ½åŠ›æ— æ³•å‘æŒ¥ã€‚é’ˆå¯¹è¿™ä¸€é—®é¢˜æœ¬æ–‡å°†ä»‹ç»Â TKEStackÂ å¦‚ä½•å€ŸåŠ©è…¾è®¯äº‘åŸç”Ÿåˆ†å¸ƒå¼äº‘ä¸­å¿ƒæ³¨å†Œé›†ç¾¤çš„åŠŸèƒ½æ‰“ç ´ç½‘ç»œè¾¹ç•Œçš„é™åˆ¶ï¼Œå°†ç½‘ç»œç¯å¢ƒç›¸å¯¹éš”ç¦»çš„é›†ç¾¤çº³å…¥åˆ°Â TKEStackÂ çš„ç®¡æ§é¢ï¼Œè¿›è¡Œç»Ÿä¸€ç®¡æ§ã€‚</em></p><h2 id=tkestack-çš„å¯¼å…¥é›†ç¾¤åŠŸèƒ½>TKEStack çš„å¯¼å…¥é›†ç¾¤åŠŸèƒ½</h2><p>å¼€æºç‰ˆ TKEStack çš„é›†ç¾¤ç®¡ç†ä¸­<sup>[1]</sup>å­˜åœ¨ä¸¤ç§é›†ç¾¤çš„æ¦‚å¿µï¼Œä¸€ç§æ˜¯<code>ç‹¬ç«‹é›†ç¾¤</code>ï¼Œå¦ä¸€ç§æ˜¯<code>å¯¼å…¥é›†ç¾¤</code>ã€‚</p><p>å…¶ä¸­<code>ç‹¬ç«‹é›†ç¾¤</code>éœ€è¦ç”¨æˆ·æä¾›å¯è¢« TKEStack è®¿é—®çš„ Linux æœºå™¨çš„è®¿é—®å‡­è¯ï¼ŒTKEStack å°†ä»¥ç”¨æˆ·æä¾›çš„æœºå™¨ä½œä¸ºåŸºç¡€è®¾æ–½ï¼Œä» 0 æ­å»ºå¯è¢« TKEStack ç®¡æ§çš„ K8s é›†ç¾¤ã€‚</p><img alt=ç‹¬ç«‹é›†ç¾¤ width=100% src=baremetal-cluster.png><p><code>å¯¼å…¥é›†ç¾¤</code>åˆ™æ˜¯å°†ç”¨æˆ·çš„ç°å­˜é›†ç¾¤çº³å…¥åˆ° TKEStack çš„ç®¡æ§ä¹‹ä¸‹ï¼Œä½†éœ€è¦æ­¤é›†ç¾¤å¯ä»¥è¢« TKEStack è®¿é—®åˆ°ï¼ˆæ— éœ€è¢«å¯¼å…¥é›†ç¾¤å¯è®¿é—® TKEStackï¼‰ï¼Œç”¨æˆ·åœ¨æ»¡è¶³æ­¤æ¡ä»¶å‰æä¸‹å¯æä¾›è¢«å¯¼å…¥é›†ç¾¤çš„è®¿é—®å‡­è¯ï¼Œä¾¿å¯å°†é›†ç¾¤çº³å…¥åˆ° TKEStack ç®¡æ§è§†é‡å†…ã€‚</p><img alt=å¯¼å…¥é›†ç¾¤ width=100% src=import-cluster.png><p>ä½†æ˜¯åœ¨ç°å®ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¢«å¯¼å…¥é›†ç¾¤æœ‰æå¤§çš„å¯èƒ½æ€§å¤„äºå¤–ç½‘æ— æ³•è®¿é—®çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å€ŸåŠ©è…¾è®¯äº‘çš„åˆ†å¸ƒå¼äº‘ä¸­å¿ƒæ¥æ‰“é€š TKEStack ä¸è¢«å¯¼å…¥é›†ç¾¤é—´çš„ç½‘ç»œè¾¹ç•Œé™åˆ¶ã€‚</p><h2 id=æ‰“ç ´ç½‘ç»œè¾¹ç•Œ>æ‰“ç ´ç½‘ç»œè¾¹ç•Œ</h2><p>äº‘åŸç”Ÿåˆ†å¸ƒå¼äº‘ä¸­å¿ƒï¼ˆTencent Kubernetes Engine Distributed Cloud Centerï¼ŒTDCCï¼‰<sup>[2]</sup> æ˜¯è…¾è®¯é¢å‘å¤šäº‘å¤šé›†ç¾¤åœºæ™¯çš„åº”ç”¨ç®¡ç†å¹³å°ï¼Œæ”¯æŒç”¨æˆ·å°†äº‘åŸç”ŸåŒ–çš„åº”ç”¨æ‰©å±•åˆ°åˆ†å¸ƒå¼äº‘ï¼Œæ‰“é€šå…¬æœ‰äº‘ã€ç§æœ‰äº‘ã€è¾¹ç¼˜äº‘çš„ç•Œé™ï¼Œå°†å„ç§æˆç†Ÿçš„é›†ç¾¤ã€ç½‘ç»œã€å­˜å‚¨ã€å¾®æœåŠ¡ã€è¿ç»´ç­‰å…¬æœ‰äº‘äº§å“å’ŒæœåŠ¡äº¤ä»˜è‡³æ›´æ¥è¿‘ç”¨æˆ·å’Œæ•°æ®çš„ä½ç½®ï¼Œç¡®ä¿ä¸åŒäº‘åŸºç¡€è®¾æ–½ä¸‹æ‹¥æœ‰ä¸€è‡´çš„æ§åˆ¶å¹³é¢ï¼Œå¹¶ä¸”æä¾›å¯é æ€§ä¿è¯å’Œå®‰å…¨åˆè§„ä¿è¯ï¼Œæ»¡è¶³ä¼ä¸šç”¨æˆ·çš„å¤šäº‘ç®¡ç†ã€åº”ç”¨æ²»ç†ã€é«˜å¯ç”¨å®¹ç¾ç­‰åœºæ™¯è¯‰æ±‚ã€‚</p><p>ä¸‹é¢ç¬”è€…å°†æ¼”ç¤ºåœ¨å®¶åº­ç½‘ç»œç¯å¢ƒä¸‹ï¼ˆå¯è®¿é—®å…¬ç½‘ï¼‰ä½¿ç”¨ kind<sup>[3]</sup> åˆ›å»ºä¸€ä¸ª K8s é›†ç¾¤ï¼Œå¹¶å€ŸåŠ©åˆ†å¸ƒå¼äº‘ä¸­å¿ƒï¼Œå°†å…¶å¯¼å…¥ä¸€ä¸ªç§æœ‰äº‘ç½‘ç»œç¯å¢ƒä¸‹ï¼ˆå¯è®¿é—®å…¬ç½‘ï¼‰çš„ TKEStackã€‚ç”±äº TKEStack åœ¨ v1.8 release æ—¶äº‘åŸç”Ÿåˆ†å¸ƒå¼äº‘ä¸­å¿ƒè¿˜æœªä¸Šçº¿ï¼Œè¿™é‡Œéœ€è¦æˆ‘ä»¬ä½¿ç”¨ daily build ç‰ˆæœ¬è¿›è¡Œä½“éªŒï¼Œè¯¥åŠŸèƒ½çš„æ­£å¼å‘å¸ƒåˆ™éœ€è¦ç­‰åˆ°ç¨æ™šäº› TKEStack v1.9.0 å‘å¸ƒï¼Œdaily build ç‰ˆæœ¬ä¸‹è½½å¯å‚è€ƒä»¥ä¸‹å‘½ä»¤ï¼š</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>version</span><span style=color:#ce5c00;font-weight:700>=</span>310e18e0d696ee0aa57dfe38655b99726eab9f5c <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> wget https://tke-release-1251707795.cos.ap-guangzhou.myqcloud.com/tke-installer-linux-amd64-<span style=color:#000>$version</span>.run<span style=color:#ce5c00;font-weight:700>{</span>,.sha256<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> sha256sum --check --status tke-installer-linux-amd64-<span style=color:#000>$version</span>.run.sha256 <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> chmod +x tke-installer-linux-amd64-<span style=color:#000>$version</span>.run <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ./tke-installer-linux-amd64-<span style=color:#000>$version</span>.run
</code></pre></div><h3 id=åˆ›å»º-kind-é›†ç¾¤>åˆ›å»º kind é›†ç¾¤</h3><p>è¿™é‡Œç¬”è€…åœ¨è‡ªå·±çš„è™šæ‹Ÿæœºä¸Šä½¿ç”¨ kind åˆ›å»ºä¸€ä¸ªé›†ç¾¤ï¼Œé¦–å…ˆæ˜¯å®‰è£… kindï¼š</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.11.1/kind-linux-amd64
chmod +x ./kind
mv kind /usr/bin/
</code></pre></div><p>ç„¶åæˆ‘ä»¬æ‰§è¡Œ kind çš„åˆ›å»ºé›†ç¾¤å‘½ä»¤ï¼š</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kind create cluster
</code></pre></div><p>å¦‚æœä¸å‡ºæ„å¤–æˆ‘ä»¬å°†åœ¨ç­‰å¾…ä¸€æ®µæ—¶é—´åå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Creating cluster <span style=color:#4e9a06>&#34;kind&#34;</span> ...
 âœ“ Ensuring node image <span style=color:#ce5c00;font-weight:700>(</span>kindest/node:v1.21.1<span style=color:#ce5c00;font-weight:700>)</span> ğŸ–¼ 
 âœ“ Preparing nodes ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
Set kubectl context to <span style=color:#4e9a06>&#34;kind-kind&#34;</span>
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Not sure what to <span style=color:#204a87;font-weight:700>do</span> next? ğŸ˜…  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
</code></pre></div><p>ä¸‹é¢å¯ä»¥ä½¿ç”¨ kubectl æ¥ç¡®è®¤ä¸€ä¸‹é›†ç¾¤æ˜¯å¦åœ¨æ­£å¸¸è¿è¡Œï¼Œè¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº† kind é›†ç¾¤çš„åˆ›å»ºå·¥ä½œã€‚å¦‚æœä½ çš„æœºå™¨ä¸Šæ²¡æœ‰ kubectl å¯ä»¥å‚è€ƒ<a href=https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/>Install and Set Up kubectl on Linux
</a>è¿›è¡Œå®‰è£…ã€‚</p><h3 id=æ³¨å†Œé›†ç¾¤åˆ°åˆ†å¸ƒå¼äº‘ä¸­å¿ƒ>æ³¨å†Œé›†ç¾¤åˆ°åˆ†å¸ƒå¼äº‘ä¸­å¿ƒ</h3><p>è®¿é—®è…¾è®¯äº‘çš„<a href=https://console.cloud.tencent.com/tdcc/cluster>åˆ†å¸ƒå¼äº‘ä¸­å¿ƒä¸»é¡µ</a>ï¼Œé€‰æ‹©æ³¨å†Œé›†ç¾¤æŒ‰é’®ã€‚</p><img alt=æ³¨å†Œé›†ç¾¤1 width=100% src=register-cluster-1.png><p>è¿™é‡Œç”±äºæˆ‘ä»¬æ˜¯é€šè¿‡ kind åˆ›å»ºçš„é›†ç¾¤å¹¶é TKEï¼Œæ‰€ä»¥æ³¨æ„é€‰æ‹©é TKE é›†ç¾¤ã€‚</p><img alt=æ³¨å†Œé›†ç¾¤2 width=100% src=register-cluster-2.png><p>æ³¨å†Œé›†ç¾¤åˆ›å»ºæˆåŠŸåæ”¹é›†ç¾¤å°†å¤„äºç­‰å¾…æ³¨å†Œçš„çŠ¶æ€ï¼Œç‚¹å‡»æŸ¥çœ‹æ³¨å†Œå‘½ä»¤ã€‚</p><img alt=æ³¨å†Œé›†ç¾¤3 width=100% src=register-cluster-3.png><p>ç”±äºæˆ‘ä»¬çš„ kind é›†ç¾¤æ— æ³•æ— æ³•é€šè¿‡å†…å¤–ä¸åˆ†å¸ƒå¼äº‘ä¸­å¿ƒé€šä¿¡ï¼Œæ³¨æ„é€‰æ‹©å¤–ç½‘è®¿é—®ã€‚</p><img alt=æ³¨å†Œé›†ç¾¤4 width=100% src=register-cluster-4.png><p>æ ¹æ®æç¤ºå°†<code>agent.yaml</code>ä¸‹è½½ä¸‹æ¥ç„¶åé€šè¿‡ kubectl éƒ¨ç½²åˆ° kind é›†ç¾¤ï¼š</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f agent.yaml
</code></pre></div><p>å¦‚æœé¡ºåˆ©æˆ‘ä»¬å°†ä¼šå¾—åˆ°ä»¥ä¸‹åé¦ˆï¼š</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>namespace/clusternet-system created
serviceaccount/clusternet-agent created
serviceaccount/clusternet-app-deployer created
deployment.apps/clusternet-agent created
clusterrole.rbac.authorization.k8s.io/clusternet:app:deployer created
clusterrolebinding.rbac.authorization.k8s.io/clusternet:app:deployer created
secret/clusternet-agent-cluster-registration created
</code></pre></div><p>æ­¤æ—¶å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ç¡®è®¤ä¸‹ agent ç›¸å…³ pod æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get pod -n clusternet-system
</code></pre></div><p>å¦‚æœæ­£å¸¸æˆ‘ä»¬åº”å½“ä¼šå¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„åé¦ˆï¼š</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE
clusternet-system    clusternet-agent-6754cc97bb-dk6r4            1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          8s
clusternet-system    clusternet-agent-6754cc97bb-sbpzg            1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          8s
clusternet-system    clusternet-agent-6754cc97bb-zfblp            1/1     Running   <span style=color:#0000cf;font-weight:700>0</span>          8s
</code></pre></div><p>å†æ£€æŸ¥åˆ†å¸ƒå¼äº‘ä¸­å¿ƒé¦–é¡µæˆ‘ä»¬å°†å‘ç° kind é›†ç¾¤å·²ç»æˆåŠŸæ³¨å†Œäº†è¿›æ¥ã€‚</p><h3 id=å¯¼å…¥é›†ç¾¤åˆ°-tkestack>å¯¼å…¥é›†ç¾¤åˆ° TKEStack</h3><p>ä¸‹é¢æˆ‘ä»¬å°†æŠŠ kind é›†ç¾¤å¯¼å…¥åˆ° TKEStack ä¸­ï¼Œé¦–å…ˆä»åˆ†å¸ƒå¼äº‘ä¸­å¿ƒå°†é›†ç¾¤çš„è®¿é—®å‡­è¯ä¸‹è½½ä¸‹æ¥ã€‚</p><img alt=æ³¨å†Œé›†ç¾¤5 width=100% src=register-cluster-5.png>
<img alt=æ³¨å†Œé›†ç¾¤6 width=100% src=register-cluster-6.png><p>ç„¶åä½¿ç”¨æ­¤å‡­è¯ä¾¿å¯å°† kind é›†ç¾¤å¯¼å…¥åˆ° TKEStack ä¸­ã€‚</p><img alt=æ³¨å†Œé›†ç¾¤7 width=100% src=register-cluster-7.png>
<img alt=æ³¨å†Œé›†ç¾¤8 width=100% src=register-cluster-8.png>
<img alt=æ³¨å†Œé›†ç¾¤9 width=100% src=register-cluster-9.png><h2 id=åŸç†>åŸç†</h2><p>è…¾è®¯äº‘åˆ†å¸ƒå¼äº‘ä¸­å¿ƒçš„æ ¸å¿ƒåŠŸèƒ½ç”± Clusternet<sup>[4]</sup> æä¾›ï¼Œè¯¥é¡¹ç›®å·²ç»å¼€æºï¼Œå¯ä»¥åœ¨ <a href=https://github.com/clusternet/clusternet>https://github.com/clusternet/clusternet</a> ä»“åº“ä¸‹æŸ¥çœ‹ä»£ç ã€‚</p><p>Clusternet çš„æ ¸å¿ƒèƒ½åŠ›é€šè¿‡<code>clusternet-hub</code>å’Œ<code>clusternet-agent</code>ä¸¤ä¸ªç»„ä»¶å®ç°ï¼Œ<code>clusternet-hub</code>çš„è§’è‰²ç±»ä¼¼ä¸€ä¸ªç”µæ’æ¿ï¼Œä»¥ aggregated apiserver<sup>[5]</sup> å½¢å¼éƒ¨ç½²åœ¨çˆ¶é›†ç¾¤ä¸­ç­‰å¾…ç€å­é›†ç¾¤è¢«æ¥å…¥è¿›æ¥ï¼›<code>clusternet-agent</code>åˆ™åœ¨å­é›†ç¾¤ä¸­å……å½“ä¸€ä¸ªæ´¾é©»ä¿¡ä½¿çš„è§’è‰²ï¼Œä¸€æ–¹é¢å°†å­é›†ç¾¤çš„ä¿¡æ¯ä¸ŠæŠ¥ç»™<code>clusternet-hub</code>ä»¥è¿›è¡Œè§‚æµ‹ï¼Œå¦ä¸€æ–¹é¢å°†ä»<code>clusternet-hub</code>ä¼ é€æ¥çš„æŒ‡ä»¤ä¸‹å‘ç»™å­é›†ç¾¤ä»¥è¿›è¡Œæ§åˆ¶ã€‚é‰´æƒæ¨¡å¼ä¸Š Clusternet å¤ç”¨äº†å­é›†ç¾¤çš„é‰´æƒèƒ½åŠ›ï¼Œé€šè¿‡ K8s çš„ user impersonation<sup>[6]</sup> èƒ½åŠ›å°†è®¤è¯ä¿¡æ¯å‘é€åˆ°<code>clusternet-agent</code>æ¨¡æ‹Ÿå¯¹åº”ç”¨æˆ·è¿›è¡Œæ“ä½œæ§åˆ¶ã€‚</p><img alt=clusternetæ¶æ„ width=100% src=clusternet-arch.png><h2 id=åŠ å…¥æˆ‘ä»¬>åŠ å…¥æˆ‘ä»¬</h2><p>åœ¨å¤§å®¶çš„å…±åŒåŠªåŠ›ä¸‹ TKEStack å·²ç»æ¼”è¿›åˆ° v1.8.x ç‰ˆæœ¬ï¼Œå…¶ä¸­åŒ…æ‹¬äº† containerd æ”¯æŒã€cilium æ”¯æŒã€é›†ç¾¤åº”ç”¨å®šä¹‰ç­‰è¯¸å¤šæ–°åŠŸèƒ½ï¼Œæ¬¢è¿å¤§å®¶åˆ° <a href=https://github.com/tkestack/tke/releases>https://github.com/tkestack/tke/releases</a> ä¸‹è½½ä½“éªŒã€‚åŒæ—¶ v1.9.0 ç‰ˆæœ¬çš„å¼€å‘å·¥ä½œæ­£åœ¨ä¸»åˆ†æ”¯ä¸Šç«çƒ­è¿›è¡Œä¸­ï¼Œv1.9.0 ç‰ˆæœ¬ä¸­é™¤äº†æœ¬æ–‡ä»‹ç»çš„æ”¯æŒå¯¼å…¥åˆ†å¸ƒå¼äº‘ä¸­å¿ƒé›†ç¾¤å¤–ï¼Œæˆ‘ä»¬ä¼šå…¨é¢å‡çº§ TKEStack çš„å„ç§ä¾èµ–ï¼ŒåŒ…æ‹¬ golang ç‰ˆæœ¬ã€CI å·¥å…·ç‰ˆæœ¬ä»¥åŠ K8s api ç‰ˆæœ¬ç­‰ï¼Œæ­¤å¤–æˆ‘ä»¬è¿˜å°†åœ¨ TKEStack çš„è½»é‡åŒ–å‡è´Ÿä¸Šåšå‡ºåŠªåŠ›ï¼ŒåŒ…æ‹¬ç§»é™¤ TKE å‘è¡Œç‰ˆ<sup>[7]</sup>ä»¥å¤–çš„é›†ç¾¤ç‰ˆæœ¬ï¼Œåˆ å‡ä¸å¸¸ç”¨çš„ addon ç»„ä»¶ç­‰ã€‚å½“ä¸‹çš„ TKEStack æ­£æ˜¯éœ€è¦ä½ åŠ å…¥çš„æ—¶å€™ï¼Œæ¬¢è¿å¤§å®¶åˆ°é¡¹ç›®ä»“åº“ <a href=https://github.com/tkestack/tke>https://github.com/tkestack/tke</a> è´¡çŒ®ä¸€ä»½åŠ›é‡ï¼</p><h2 id=å‚è€ƒèµ„æ–™>å‚è€ƒèµ„æ–™</h2><p>[1] TKEStack é›†ç¾¤ç®¡ç† [https://tkestack.github.io/docs/user-guide/platform-console/cluster-mgmt.html]</p><p>[2] è…¾è®¯äº‘åŸç”Ÿåˆ†å¸ƒå¼äº‘ä¸­å¿ƒ [https://cloud.tencent.com/document/product/1517/63246]</p><p>[3] Kind, running local Kubernetes clusters using Docker [https://kind.sigs.k8s.io/]</p><p>[4] Clusternet [https://github.com/clusternet/clusternet]</p><p>[5] Kubernetes API Aggregation Layer [https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/]</p><p>[6] User impersonation [https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation]</p><p>[7] TKE Kubernetes Distro [https://github.com/tkestack/tke-k8s-distro]</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0b6f95117da45acb1ad27804dd0b465c>TKEStack ä¸­çš„è®¤è¯ä¸é‰´æƒ</h1><div class="td-byline mb-4"><time datetime=2021-12-18 class=text-muted>2021.12.18</time></div><p><strong>Author</strong>: LeoRyu</p><p><em>è®¤è¯é‰´æƒå¯¹äº K8s è€Œè¨€å¯ä»¥è¯´æ˜¯æœ€ä¸ºå¤æ‚ã€çµæ´»å’Œå…³é”®çš„éƒ¨åˆ†ï¼Œæœ¬æ–‡å°†ä»‹ç» TKEStack ä¸­è®¤è¯é‰´æƒæœºåˆ¶æ˜¯å¦‚ä½•è¿ä½œçš„ã€‚</em></p><h2 id=å¼€å§‹ä¹‹å‰>å¼€å§‹ä¹‹å‰</h2><p>ç”±äºè®¤è¯é‰´æƒæ¶‰åŠçš„ç›¸å…³çŸ¥è¯†å¾ˆå¤šï¼Œä¸ºäº†é¿å…è¯»è€…åœ¨ä¸‹é¢æ¢ç©¶ TKEStack è®¤è¯é‰´æƒæœºåˆ¶æ—¶æŸ¥å¤„ç›¸å…³åè¯çŸ¥è¯†ï¼Œåœ¨å¼€å§‹ä¹‹å‰å…ˆä»‹ç»ä¸€äº›æœ¬æ–‡æ¶‰åŠåˆ°çš„çŸ¥è¯†æ¦‚å¿µã€‚</p><h3 id=k8s-ä¸­çš„ä¸€äº›èº«ä»½è®¤è¯æ–¹å¼>K8s ä¸­çš„ä¸€äº›èº«ä»½è®¤è¯æ–¹å¼</h3><ul><li><p>X509 å®¢æˆ·è¯ä¹¦ã€‚é€šè¿‡ç»™ API æœåŠ¡å™¨ä¼ é€’ <code>--client-ca-file=SOMEFILE</code> é€‰é¡¹ï¼Œå°±å¯ä»¥å¯åŠ¨å®¢æˆ·ç«¯è¯ä¹¦èº«ä»½è®¤è¯ã€‚ æ‰€å¼•ç”¨çš„æ–‡ä»¶å¿…é¡»åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¯ä¹¦æœºæ„ï¼Œç”¨æ¥éªŒè¯å‘ API æœåŠ¡å™¨æä¾›çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚ å¦‚æœæä¾›äº†å®¢æˆ·ç«¯è¯ä¹¦å¹¶ä¸”è¯ä¹¦è¢«éªŒè¯é€šè¿‡ï¼Œåˆ™ subject ä¸­çš„å…¬å…±åç§°ï¼ˆCommon Nameï¼‰å°±è¢« ä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·åã€‚</p></li><li><p>é™æ€ä»¤ç‰Œæ–‡ä»¶ã€‚å½“ API æœåŠ¡å™¨çš„å‘½ä»¤è¡Œè®¾ç½®äº† <code>--token-auth-file=SOMEFILE</code> é€‰é¡¹æ—¶ï¼Œä¼šä»æ–‡ä»¶ä¸­ è¯»å–æŒæœ‰è€…ä»¤ç‰Œã€‚ç›®å‰ï¼Œä»¤ç‰Œä¼šé•¿æœŸæœ‰æ•ˆï¼Œå¹¶ä¸”åœ¨ä¸é‡å¯ API æœåŠ¡å™¨çš„æƒ…å†µä¸‹ æ— æ³•æ›´æ”¹ä»¤ç‰Œåˆ—è¡¨ã€‚</p></li><li><p>æœåŠ¡è´¦å·ä»¤ç‰Œã€‚æœåŠ¡è´¦å·ï¼ˆService Accountï¼‰æ˜¯ä¸€ç§è‡ªåŠ¨è¢«å¯ç”¨çš„ç”¨æˆ·è®¤è¯æœºåˆ¶ï¼Œä½¿ç”¨ç»è¿‡ç­¾åçš„ æŒæœ‰è€…ä»¤ç‰Œæ¥éªŒè¯è¯·æ±‚ã€‚æœåŠ¡è´¦å·é€šå¸¸ç”± API æœåŠ¡å™¨è‡ªåŠ¨åˆ›å»ºå¹¶é€šè¿‡ ServiceAccount å‡†å…¥æ§åˆ¶å™¨ å…³è”åˆ°é›†ç¾¤ä¸­è¿è¡Œçš„ Pod ä¸Šã€‚ æŒæœ‰è€…ä»¤ç‰Œä¼šæŒ‚è½½åˆ° Pod ä¸­å¯é¢„çŸ¥çš„ä½ç½®ï¼Œå…è®¸é›†ç¾¤å†…è¿›ç¨‹ä¸ API æœåŠ¡å™¨é€šä¿¡ã€‚ æœåŠ¡è´¦å·ä¹Ÿå¯ä»¥ä½¿ç”¨ Pod è§„çº¦çš„ serviceAccountName å­—æ®µæ˜¾å¼åœ°å…³è”åˆ° Pod ä¸Šã€‚</p></li><li><p>OpenID Connectï¼ˆOIDCï¼‰ä»¤ç‰Œã€‚OpenID Connect æ˜¯ä¸€ç§ OAuth2 è®¤è¯æ–¹å¼ï¼Œ è¢«æŸäº› OAuth2 æä¾›è€…æ”¯æŒï¼Œä¾‹å¦‚ Azure æ´»åŠ¨ç›®å½•ã€Salesforce å’Œ Googleã€‚ åè®®å¯¹ OAuth2 çš„ä¸»è¦æ‰©å……ä½“ç°åœ¨æœ‰ä¸€ä¸ªé™„åŠ å­—æ®µä¼šå’Œè®¿é—®ä»¤ç‰Œä¸€èµ·è¿”å›ï¼Œ è¿™ä¸€å­—æ®µç§°ä½œ ID Tokenï¼ˆID ä»¤ç‰Œï¼‰ã€‚è¯¦æƒ…å¯å‚è€ƒ <a href=https://openid.net/connect/>https://openid.net/connect/</a> ã€‚</p></li></ul><p>æ›´å¤šè®¤è¯ç›¸å…³ä¿¡æ¯å¯å‚è€ƒ <a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/>ç”¨æˆ·è®¤è¯</a>[1]ã€‚</p><h3 id=k8s-ä¸­çš„ä¸€äº›é‰´æƒæ–¹å¼>K8s ä¸­çš„ä¸€äº›é‰´æƒæ–¹å¼</h3><ul><li>Nodeã€‚ä¸€ä¸ªä¸“ç”¨é‰´æƒç»„ä»¶ï¼Œæ ¹æ®è°ƒåº¦åˆ° kubelet ä¸Šè¿è¡Œçš„ Pod ä¸º kubelet æˆäºˆæƒé™ã€‚</li><li>ABACã€‚åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰å®šä¹‰äº†ä¸€ç§è®¿é—®æ§åˆ¶èŒƒå‹ï¼Œé€šè¿‡ä½¿ç”¨å°†å±æ€§ç»„åˆ åœ¨ä¸€èµ·çš„ç­–ç•¥ï¼Œå°†è®¿é—®æƒé™æˆäºˆç”¨æˆ·ã€‚ç­–ç•¥å¯ä»¥ä½¿ç”¨ä»»ä½•ç±»å‹çš„å±æ€§ï¼ˆç”¨æˆ·å±æ€§ã€èµ„æºå±æ€§ã€ å¯¹è±¡ï¼Œç¯å¢ƒå±æ€§ç­‰ï¼‰ã€‚</li><li>RBACã€‚åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰æ˜¯ä¸€ç§åŸºäºä¼ä¸šå†…ä¸ªäººç”¨æˆ·çš„è§’è‰²æ¥ç®¡ç†å¯¹ è®¡ç®—æœºæˆ–ç½‘ç»œèµ„æºçš„è®¿é—®çš„æ–¹æ³•ã€‚åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­ï¼Œæƒé™æ˜¯å•ä¸ªç”¨æˆ·æ‰§è¡Œç‰¹å®šä»»åŠ¡çš„èƒ½åŠ›ï¼Œ ä¾‹å¦‚æŸ¥çœ‹ã€åˆ›å»ºæˆ–ä¿®æ”¹æ–‡ä»¶ã€‚</li><li>Webhookã€‚WebHook æ˜¯ä¸€ä¸ª HTTP å›è°ƒï¼šå‘ç”ŸæŸäº›äº‹æƒ…æ—¶è°ƒç”¨çš„ HTTP POSTï¼› é€šè¿‡ HTTP POST è¿›è¡Œç®€å•çš„äº‹ä»¶é€šçŸ¥ã€‚å®ç° WebHook çš„ Web åº”ç”¨ç¨‹åºä¼šåœ¨å‘ç”ŸæŸäº›äº‹æƒ…æ—¶ å°†æ¶ˆæ¯å‘å¸ƒåˆ° URLã€‚</li><li>AlwaysAllowã€‚å…è®¸æ‰€æœ‰è¯·æ±‚ã€‚ä»…åœ¨ä½ ä¸éœ€è¦ API è¯·æ±‚ çš„é‰´æƒæ—¶æ‰ä½¿ç”¨ã€‚</li><li>AlwaysDenyã€‚é˜»æ­¢æ‰€æœ‰è¯·æ±‚ã€‚ä»…ç”¨äºæµ‹è¯•ã€‚</li></ul><p>æ›´å¤šè®¤è¯ç›¸å…³ä¿¡æ¯å¯å‚è€ƒ <a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/authorization/>é‰´æƒæ¦‚è¿°</a>[2]ã€‚</p><h3 id=casbin>Casbin</h3><p>Casbin æ˜¯ä¸€æ¬¾è½»é‡çº§çš„å¼€æºè®¿é—®æ§åˆ¶æ¡†æ¶ï¼Œæ”¯æŒ PERM æ¨¡å¼ï¼ˆPolicyï¼ŒEffectï¼ŒRequestï¼ŒMatchersï¼‰ï¼Œç›¸å…³æ¦‚å¿µå¦‚ä¸‹ï¼š</p><ul><li>Requestï¼šå®šä¹‰äº†è¯·æ±‚çš„å…ƒç»„å¯¹è±¡ï¼Œè‡³å°‘åŒ…å«è®¿é—®å®ä½“ï¼ˆsubï¼‰ã€è®¿é—®çš„èµ„æºï¼ˆobjï¼‰å’Œè¡Œä¸ºï¼ˆActionï¼‰ï¼Œä¾‹å¦‚ï¼šr={sub, obj,act}ã€‚</li><li>Policyï¼šå®šä¹‰äº†é‰´æƒè§„åˆ™å„å­—æ®µçš„åç§°å’Œé¡ºåºï¼Œè‡³å°‘åŒ…å«è®¿é—®å®ä½“ï¼ˆsubï¼‰ã€è®¿é—®çš„èµ„æºï¼ˆobjï¼‰å’Œè¡Œä¸ºï¼ˆActionï¼‰ï¼Œä¾‹å¦‚ï¼šp={sub, obj, act}ã€‚</li><li>Matchersï¼šå®šä¹‰äº† Request å’Œ Policy çš„åŒ¹é…è§„åˆ™ã€‚</li><li>Effectï¼šç”¨äºå¯¹æ‰€æœ‰ Matchers åŒ¹é…åçš„ç»“æœï¼Œå†è¿›è¡Œä¸€æ¬¡é€»è¾‘ç»„åˆåˆ¤æ–­ï¼ˆä¾‹å¦‚ï¼še = some(where (p.eft == allow)) && !some(where (p.eft == deny))ï¼Œè¿™ä¸ªä¾‹å­ç»„åˆçš„é€»è¾‘å«ä¹‰æ˜¯ï¼šå¦‚æœæœ‰åŒ¹é…å‡ºç»“æœä¸º alllow çš„ç­–ç•¥ï¼Œå¹¶ä¸”æ²¡æœ‰åŒ¹é…å‡ºç»“æœä¸º deny çš„ç­–ç•¥ï¼Œåˆ™ç»“æœä¸ºçœŸï¼Œå¦‚æœæœ‰ä»»ä½•denyï¼Œéƒ½ä¸ºå‡ï¼‰ã€‚</li></ul><p>å…³äºæœ¬é¡¹ç›®è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ <a href=https://casbin.org/docs/zh-CN/overview>Casbin æ¦‚è¿°</a>[3]ã€‚</p><h2 id=ä¸¤ç§è®¤è¯é‰´æƒåœºæ™¯>ä¸¤ç§è®¤è¯é‰´æƒåœºæ™¯</h2><p>TKEStack æ‰©å±• K8s API çš„æ–¹å¼æ˜¯é€šè¿‡ aggregated apiserver[4] å®ç°çš„ï¼Œè¿™ç§æ–¹å¼ä¸ CRD çš„æ–¹å¼ä¸åŒï¼Œæ¯ä¸€ä¸ªæ‰©å±•ç»„ä»¶éƒ½å¯ä»¥è¢«è§†ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ APIServerï¼Œè¿™ä½¿å¾— TKEStack çš„è®¤è¯é‰´æƒç›¸è¾ƒä¹‹ä¸‹æ›´åŠ çµæ´»ï¼Œä½†ä¹Ÿæ›´åŠ å¤æ‚ã€‚ä¸ºäº†æ›´åŠ æ–¹ä¾¿å’Œæ¸…æ™°åœ°å±•ç¤ºè®¤è¯é‰´æƒçš„æµç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ†ä¸ºä¸¤ç§åœºæ™¯åˆ†åˆ«å±•å¼€ï¼šç¬¬ä¸€ç§æ˜¯ç”¨æˆ·é€šè¿‡æµè§ˆå™¨ç”± tke-gateway å…¥å£è®¿é—®å„ä¸ªç»„ä»¶çš„èµ„æºï¼›ç¬¬äºŒç§æ˜¯ç”¨æˆ·é€šè¿‡ kubectl ç”± kube-apiserver å…¥å£è®¿é—®å„ä¸ªç»„ä»¶çš„èµ„æºã€‚</p><h2 id=ç”±æµè§ˆå™¨å‘èµ·çš„è®¿é—®>ç”±æµè§ˆå™¨å‘èµ·çš„è®¿é—®</h2><h3 id=è®¤è¯>è®¤è¯</h3><p>ç”¨æˆ·é€šè¿‡æµè§ˆå™¨ç™»é™†è®¿é—®çš„ç”¨æˆ·ä¿¡æ¯å¹¶ä¸æ˜¯ K8s é›†ç¾¤å¯ä»¥è¯†åˆ«çš„ç”¨æˆ·ï¼Œæ— æ³•ç”±é›†ç¾¤æœ¬èº«è¿›è¡Œè®¤è¯æµç¨‹ï¼Œéœ€è¦å¤–éƒ¨çš„ OIDC provider è¿›è¡Œè®¤è¯ã€‚åœ¨ TKEStack ä¸­æ‰¿æ‹…æ­¤å·¥ä½œçš„æ˜¯ tke-auth ç»„ä»¶ï¼Œtke-auth ä¸­æ˜¯é€šè¿‡ <a href=https://github.com/dexidp/dex>dex</a> å®ç°çš„ OIDC æœåŠ¡ã€‚</p><p>åœ¨ç”±æµè§ˆå™¨å‘èµ·çš„è®¿é—®åœºæ™¯ä¸‹ï¼Œè®¤è¯æµç¨‹çš„é“¾è·¯å¤§è‡´åˆ†ä¸ºä¸¤æ­¥éª¤ï¼š</p><ol><li><code>ç”¨æˆ·æµè§ˆå™¨ä¸­ç™»å½• -> tke-gateway -> tke-authè¿”å›è®¤è¯ä¿¡æ¯å‡­è¯ -> è®¾ç½®è®¿é—®å‡­è¯åˆ°æµè§ˆå™¨</code></li><li><code>å·²æœ‰è®¿é—®å‡­è¯çš„å‰ç«¯ -> tke-gateway -> tke-xxxx -> tke-authæ ¡éªŒè®¤è¯å‡­è¯</code></li></ol><p>æ•´ä¸ªè®¤è¯è¿‡ç¨‹ä¸­æ•°æ®ä¼ è¾“éƒ½æ˜¯é€šè¿‡æµè§ˆå™¨æˆ–æ˜¯ TKEStack ç³»ç»Ÿç»„ä»¶å®Œæˆçš„ï¼Œæ²¡æœ‰ kube-apiserver çš„å‚ä¸ã€‚</p><h3 id=é‰´æƒ>é‰´æƒ</h3><p>å½“å‰ç‰ˆæœ¬ TKEStack ç³»ç»Ÿç»„ä»¶çš„é‰´æƒæ¨¡å¼é»˜è®¤æ˜¯ä»¥ <a href=https://kubernetes.io/docs/reference/access-authn-authz/authorization/>SubjectAccessReview</a> ç»§æ‰¿äº† kube-apiserver çš„é‰´æƒæ¨¡å¼ï¼Œè€Œ kube-apiserver ä¸­é‰´æƒæ¨¡å¼é…ç½®äº† webhook æŒ‡å‘äº† tke-auth ç»„ä»¶ã€‚</p><p>tke-auth ä¸­çš„é‰´æƒæ˜¯åŸºäº <a href=https://github.com/casbin/casbin>casbin</a> å®ç°çš„ï¼ŒåŸºäºå…¶ PERM æ¨¡å‹ TKEStack å®Œæˆäº†ä¸€å¥— RBAC æ¨¡å‹çš„å®ç°ï¼š</p><pre><code>[request_definition]
r = sub, dom, obj, act

[policy_definition]
p = sub, dom, obj, act, eft

[role_definition]
g = _, _, _

[policy_effect]
e = some(where (p.eft == allow)) &amp;&amp; !some(where (p.eft == deny))

[matchers]
m = g(r.sub, p.sub, r.dom) &amp;&amp; keyMatchCustom(r.obj, p.obj) &amp;&amp; keyMatchCustom(r.act, p.act)
</code></pre><ul><li>request_definitionï¼šå®šä¹‰äº†æ¨¡å‹çš„ Request</li><li>policy_definitionï¼šå®šä¹‰äº†æ¨¡å‹çš„ Policy</li><li>role_definitionï¼šå®šä¹‰äº†æ¨¡å‹çš„ç”¨æˆ·å’Œè§’è‰²çš„æ˜ å°„å…³ç³»ï¼Œ ä¸‰ä¸ªç©ºç¼ºåˆ†åˆ«è¡¨ç¤ºç”¨æˆ·, è§’è‰², åŸŸï¼ŒTKEStack ä½¿ç”¨çš„åŸŸä¸ºä¸šåŠ¡ ID</li><li>policy_effectï¼šå®šä¹‰äº†æ¨¡å‹çš„ Effect</li><li>matchersï¼šå®šä¹‰äº†æ¨¡å‹çš„åŒ¹é…æ–¹å¼ï¼ŒkeyMatchCustom ä¸ºè‡ªå®šä¹‰åŒ¹é…å‡½æ•°ï¼Œæ”¯æŒä»¥æ­£åˆ™åŒ¹é…å’Œé€šé…ç¬¦çš„æ–¹å¼ï¼ŒåŒ¹é… Role å’Œ Policy çš„å­—æ®µ</li></ul><p>ç”¨æˆ·é€šè¿‡æµè§ˆå™¨è®¿é—®åœºæ™¯ä¸‹ TKEStack çš„é‰´æƒæµç¨‹æ•´ä¸ªé“¾è·¯å¦‚ä¸‹ï¼š</p><p><code>ç”¨æˆ·æµè§ˆå™¨å‘èµ·è¯·æ±‚ -> tke-gateway -> tke-xxx -> kube-apiserver webhook -> tke-authè¿”å›é‰´æƒç»“æœ</code></p><h2 id=é›†ç¾¤å†…ç”±-kubectl-å‘èµ·çš„è¯·æ±‚>é›†ç¾¤å†…ç”± kubectl å‘èµ·çš„è¯·æ±‚</h2><h3 id=è®¤è¯-1>è®¤è¯</h3><p>é›†ç¾¤å†…é€šè¿‡ kubectl å‘èµ·è¯·æ±‚åœºæ™¯ä¸‹çš„è®¤è¯æµç¨‹ä¸ K8s æœ¬èº«çš„è®¤è¯æµç¨‹åŸºæœ¬æ— å¼‚ï¼Œå› æ­¤æ•´ä¸ªé“¾è·¯ä¹Ÿéå¸¸ç®€å•ï¼š</p><p><code>kubectl è¯»å– kubeconfig ä¸­çš„è®¤è¯ä¿¡æ¯ -> kube-apiserver æ£€éªŒè®¤è¯ä¿¡æ¯</code></p><p>ç”±äºæ­¤åœºæ™¯ä¸‹çš„ç”¨æˆ·ä¿¡æ¯æ˜¯å¯ä»¥è¢« K8s è¯†åˆ«çš„ï¼Œä¸” kubectl æ˜¯ç›´æ¥è¿æ¥ kube-apiserver çš„ï¼Œè®¤è¯æµç¨‹åœ¨è¯·æ±‚åˆ°è¾¾ TKEStack ç³»ç»Ÿç»„ä»¶ä¹‹å‰å°±å®Œæˆäº†ã€‚</p><h3 id=é‰´æƒ-1>é‰´æƒ</h3><p>ä¹‹å‰åœ¨ç”±æµè§ˆå™¨å‘èµ·è®¿é—®åœºæ™¯ä¸­å·²ç»æåˆ° TKEStack ç³»ç»Ÿç»„ä»¶çš„é‰´æƒæ¨¡å¼æ˜¯ä»¥ <a href=https://kubernetes.io/docs/reference/access-authn-authz/authorization/>SubjectAccessReview</a> ç»§æ‰¿äº† kube-apiserver çš„é‰´æƒæ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼ä¹ŸåŒæ ·é€‚ç”¨äºé›†ç¾¤å†…ç”± kubectl å‘èµ·è¯·æ±‚çš„åœºæ™¯ï¼Œåªä¸è¿‡åœ¨ kube-apiserver ä¸­ç”Ÿæ•ˆçš„é‰´æƒæ¨¡å¼ä¸å†æ˜¯æŒ‡å‘ tke-auth çš„ webhookï¼Œè€Œæ˜¯ K8s çš„ RBAC/ABAC æ¨¡å¼ã€‚</p><p>æ•´ä¸ªé‰´æƒæµç¨‹çš„é“¾è·¯å¦‚ä¸‹ï¼š</p><p><code>kubectl å‘èµ·è¯·æ±‚ -> kube-apiserver -> tke-xxx -> kube-apiserver è¿”å› RBAC/ABAC é‰´æƒç»“æœ</code></p><p>[1] Kubernetes ç”¨æˆ·è®¤è¯ [https://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/]</p><p>[2] Kubernetes é‰´æƒæ¦‚è¿° [https://kubernetes.io/zh/docs/reference/access-authn-authz/authorization/]</p><p>[3] Casbin æ¦‚è¿° [https://casbin.org/docs/zh-CN/overview]</p><p>[4] Kubernetes API Aggregation Layer [https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/]</p></div><div class=td-content style=page-break-before:always><h1 id=pg-94a52bb4e5649acbc639e6f5ab3e615f>TKEStack é›†ç¾¤å®¹å™¨è¿è¡Œæ—¶è¿ç§»</h1><div class="td-byline mb-4"><time datetime=2021-09-01 class=text-muted>2021.09.01</time></div><p><strong>Author</strong>: LeoRyu</p><p><em>Kuberneteså®£å¸ƒåœ¨1.20ç‰ˆæœ¬ä¹‹åå°†å¼ƒç”¨Dockerä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œåœ¨2021å¹´æœ«å‘å¸ƒçš„1.23ç‰ˆæœ¬ä¸­å°†å½»åº•ç§»é™¤dockershimç»„ä»¶ã€‚å¯èƒ½å¾ˆå¤šæœ‹å‹ä¸æ˜¯å¾ˆæ¸…æ¥šå®¹å™¨è¿è¡Œæ—¶è¿ç§»å·¥ä½œè¦æ€ä¹ˆåšï¼Œæœ¬æ–‡å°†å°±TKEStackçš„globalé›†ç¾¤å¦‚ä½•è¿›è¡Œå®¹å™¨è¿è¡Œæ—¶è¿ç§»åšè¯¦ç»†ä»‹ç»ã€‚åŒæ—¶ï¼Œæœ¬æ–‡éTKEStack globaé›†ç¾¤çš„å®¹å™¨è¿è¡Œæ—¶è¿ç§»ä¹Ÿæœ‰å¾ˆå¥½çš„å‚è€ƒä»·å€¼ã€‚</em></p><h2 id=é™åˆ¶æ¡ä»¶>é™åˆ¶æ¡ä»¶</h2><ol><li>é›†ç¾¤è¿ç§»å‰è¯·ç¡®è®¤masterèŠ‚ç‚¹ä¸æ­¢ä¸€ä¸ªï¼Œå•masterèŠ‚ç‚¹åˆ‡æ¢å®¹å™¨è¿è¡Œæ—¶åªèƒ½é€šè¿‡å¤‡ä»½etcdæ•°æ®å†æ¢å¤é›†ç¾¤æ–¹å¼ï¼Œæœ¬æ–‡æä¾›æ–¹æ³•å¹¶ä¸é€‚ç”¨ã€‚</li><li>è¿ç§»å‰å€¾ç¡®è®¤å½“å‰K8sé›†ç¾¤æ”¯æŒä»¥containerdä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œè¿™é‡Œå»ºè®®é›†ç¾¤ç‰ˆæœ¬ä¸º1.19+ã€‚</li></ol><h2 id=è¿ç§»æµç¨‹>è¿ç§»æµç¨‹</h2><h3 id=å‡†å¤‡å·¥ä½œ>å‡†å¤‡å·¥ä½œ</h3><ol><li>æ¯ä¸ªèŠ‚ç‚¹ä¸Šä¿®æ”¹ docker daemon.json: <code>vim /etc/docker/daemon.json</code>ï¼Œå°† <code>"live-restore"</code> ä¿®æ”¹ä¸º <code>false</code>ã€‚</li><li>æ¯ä¸ªèŠ‚ç‚¹é‡å¯ dcoker æœåŠ¡ï¼š <code>systemctl daemon-reload && systemctl restart docker.service</code>ã€‚</li><li>ä¿®æ”¹galaxy dsï¼š<code>kubectl edit -n kube-system ds galaxy-daemonset</code>ï¼Œåœ¨<code>volumeMounts</code>å’Œ<code>volumes</code>ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>...
        volumeMounts:
        - name: containerd-run
          mountPropagation: Bidirectional
          mountPath: /var/run/netns/
...
      volumes:
      - name: containerd-run
        hostPath:
          path: /var/run/netns
</code></pre></div><h3 id=émaster0èŠ‚ç‚¹è¿ç§»>émaster0èŠ‚ç‚¹è¿ç§»</h3><p>églobalé›†ç¾¤é¦–ä¸ªmasterèŠ‚ç‚¹çš„è¿ç§»æ­¥éª¤ã€‚</p><ol><li>å°é”èŠ‚ç‚¹ï¼š<code>kubectl cordon xxx</code>ã€‚</li><li>é©±é€èŠ‚ç‚¹ï¼š<code>kubectl drain xxx --ignore-daemonsets --delete-local-data</code>ï¼Œæ³¨æ„è¯¥æ“ä½œä¼šåˆ é™¤ <code>pod</code> çš„æœ¬åœ°ä¸´æ—¶æ•°æ®ã€‚</li><li>åœæ­¢KubeletæœåŠ¡: <code>systemctl stop kubelet</code>ã€‚</li><li>åœæ­¢DockeræœåŠ¡ï¼š<code>systemctl disable docker.service && systemctl stop docker.service && systemctl stop containerd.service</code>ã€‚</li><li>ä¸‹è½½containerdï¼Œè¿™é‡Œä» <code>https://github.com/containerd/nerdctl/releases</code> ä¸‹è½½ï¼š<code>curl -LO https://github.com/containerd/nerdctl/releases/download/v0.11.1/nerdctl-full-0.11.1-linux-amd64.tar.gz</code>ã€‚</li><li>å®‰è£…containerdï¼š<code>tar Cxzvvf /usr/local nerdctl-full-0.11.1-linux-amd64.tar.gz</code>ã€‚</li><li>æ·»åŠ containerdè‡ªå®šä¹‰é…ç½®ï¼š</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cat /etc/containerd/config.toml
<span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span>
<span style=color:#000>root</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/var/lib/containerd&#34;</span>
<span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/run/containerd&#34;</span>

<span style=color:#ce5c00;font-weight:700>[</span>grpc<span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#000>address</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/run/containerd/containerd.sock&#34;</span>
  <span style=color:#000>gid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
  <span style=color:#000>max_recv_message_size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>16777216</span>
  <span style=color:#000>max_send_message_size</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>16777216</span>
  <span style=color:#000>uid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>

<span style=color:#ce5c00;font-weight:700>[</span>plugins<span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#ce5c00;font-weight:700>[</span>plugins.<span style=color:#4e9a06>&#34;io.containerd.grpc.v1.cri&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>sandbox_image</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;registry.tke.com/library/pause:3.2&#34;</span>
    <span style=color:#ce5c00;font-weight:700>[</span>plugins.<span style=color:#4e9a06>&#34;io.containerd.grpc.v1.cri&#34;</span>.cni<span style=color:#ce5c00;font-weight:700>]</span>
      <span style=color:#000>bin_dir</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/opt/cni/bin&#34;</span>
      <span style=color:#000>conf_dir</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;/etc/cni/net.d&#34;</span>
    <span style=color:#ce5c00;font-weight:700>[</span>plugins.<span style=color:#4e9a06>&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd<span style=color:#ce5c00;font-weight:700>]</span>
      
      <span style=color:#000>default_runtime_name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;runc&#34;</span>
      
    <span style=color:#ce5c00;font-weight:700>[</span>plugins.<span style=color:#4e9a06>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry<span style=color:#ce5c00;font-weight:700>]</span>
      <span style=color:#ce5c00;font-weight:700>[</span>plugins.<span style=color:#4e9a06>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs<span style=color:#ce5c00;font-weight:700>]</span>
        
        <span style=color:#ce5c00;font-weight:700>[</span>plugins.<span style=color:#4e9a06>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span style=color:#4e9a06>&#34;registry.tke.com&#34;</span>.tls<span style=color:#ce5c00;font-weight:700>]</span>
          <span style=color:#000>insecure_skip_verify</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
        
        <span style=color:#ce5c00;font-weight:700>[</span>plugins.<span style=color:#4e9a06>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span style=color:#4e9a06>&#34;default.registry.tke.com&#34;</span>.tls<span style=color:#ce5c00;font-weight:700>]</span>
          <span style=color:#000>insecure_skip_verify</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</code></pre></div><ol start=8><li>ä¿®æ”¹ <code>kubelet</code> å‚æ•°ï¼š</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cat /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
<span style=color:#8f5902;font-style:italic># Note: This dropin only works with kubeadm and kubelet v1.11+</span>
<span style=color:#ce5c00;font-weight:700>[</span>Service<span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>Environment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&#34;</span>
<span style=color:#000>Environment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&#34;</span>
<span style=color:#000>Environment</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;KUBELET_RUNTIME_ARGS=--container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock&#34;</span>
<span style=color:#8f5902;font-style:italic># This is a file that &#34;kubeadm init&#34; and &#34;kubeadm join&#34; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span>
<span style=color:#000>EnvironmentFile</span><span style=color:#ce5c00;font-weight:700>=</span>-/var/lib/kubelet/kubeadm-flags.env
<span style=color:#8f5902;font-style:italic># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span>
<span style=color:#8f5902;font-style:italic># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span>
<span style=color:#000>EnvironmentFile</span><span style=color:#ce5c00;font-weight:700>=</span>-/etc/sysconfig/kubelet
<span style=color:#000>ExecStart</span><span style=color:#ce5c00;font-weight:700>=</span>
<span style=color:#000>ExecStart</span><span style=color:#ce5c00;font-weight:700>=</span>/usr/bin/kubelet <span style=color:#000>$KUBELET_KUBECONFIG_ARGS</span> <span style=color:#000>$KUBELET_CONFIG_ARGS</span> <span style=color:#000>$KUBELET_KUBEADM_ARGS</span> <span style=color:#000>$KUBELET_EXTRA_ARGS</span> <span style=color:#000>$KUBELET_RUNTIME_ARGS</span>
</code></pre></div><ol start=9><li><p>æ¿€æ´» <code>containerd</code> æœåŠ¡ï¼š<code>systemctl daemon-reload && systemctl enable containerd.service && systemctl start containerd.service</code>ã€‚</p></li><li><p>å¯åŠ¨kubeletæœåŠ¡ï¼š<code>systemctl daemon-reload && systemctl start kubelet.service</code>ã€‚</p></li><li><p>è§£é™¤èŠ‚ç‚¹å°é”ï¼š<code>kubectl uncordon xxx</code>ã€‚</p></li></ol><h3 id=master0èŠ‚ç‚¹è¿ç§»>master0èŠ‚ç‚¹è¿ç§»</h3><p>å¦‚æœä½ çš„é›†ç¾¤ä¸æ˜¯TKEStackçš„globalé›†ç¾¤è¯·å¿½ç•¥ä»¥ä¸‹å†…å®¹ã€‚å¦‚æœä½ ç¡®å®šä½ å½“å‰çš„TKEStackæ²¡æœ‰ä½¿ç”¨å†…ç½®çš„tke-registryä½œä¸ºé•œåƒä»“åº“ï¼Œä¹Ÿå¯ä»¥å¿½ç•¥ä¸€ä¸‹å†…å®¹ã€‚</p><p>ä¸ç¡®å®šå“ªä¸ªæ˜¯master0èŠ‚ç‚¹çš„è¯ï¼Œå¯ä»¥é€šè¿‡<code>kubectl get pod -n tke -owide | grep tke-registry-api</code>æŸ¥çœ‹podæ‰€åœ¨èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹å°±æ˜¯mater0èŠ‚ç‚¹ã€‚</p><p>master0èŠ‚ç‚¹è¿ç§»æ”¾åœ¨å…¶ä»–èŠ‚ç‚¹è¿ç§»å®Œæˆååœ¨è¿›è¡Œï¼Œç›¸è¾ƒémaster0è¿ç§»å¤šå‡ºäº†ä¸€ä¸‹æ­¥éª¤ï¼š</p><ol><li>åœ¨æ­¥éª¤<code>1. å°é”èŠ‚ç‚¹</code>å‰å¤‡ä»½master0èŠ‚ç‚¹é•œåƒåˆ°å…¶ä»–masterèŠ‚ç‚¹ï¼š</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#8f5902;font-style:italic>## ä½¿ç”¨dockeråœ¨master0èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼š</span>
docker save <span style=color:#204a87;font-weight:700>$(</span>docker images <span style=color:#000;font-weight:700>|</span> sed <span style=color:#4e9a06>&#39;1d&#39;</span> <span style=color:#000;font-weight:700>|</span> awk <span style=color:#4e9a06>&#39;{print $1 &#34;:&#34; $2}&#39;</span><span style=color:#204a87;font-weight:700>)</span> -o backup.tar

<span style=color:#8f5902;font-style:italic>## ä½¿ç”¨nerdctlåœ¨å…¶ä»–masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼š</span>
nerdctl --namespace<span style=color:#ce5c00;font-weight:700>=</span>k8s.io load -i backup.tar
</code></pre></div><ol start=2><li>åœ¨æ­¥éª¤<code>9. æ¿€æ´» </code>containerd<code> æœåŠ¡</code>ä¹‹åï¼Œæ­¥éª¤<code>10. å¯åŠ¨kubeletæœåŠ¡</code>ä¹‹å‰åŠ è½½master0èŠ‚ç‚¹é•œåƒï¼š</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#8f5902;font-style:italic>## ä½¿ç”¨nerdctlåœ¨master0èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼š</span>
nerdctl --namespace<span style=color:#ce5c00;font-weight:700>=</span>k8s.io load -i backup.tar
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-bdcc72ec4f0032b1d49860cf2520f4b3>TKEStack å®¹å™¨æ··åˆäº‘èƒ½åŠ›ä»‹ç»ï¼ˆ1ï¼‰ï¼šç»Ÿä¸€åŸºçŸ³</h1><div class="td-byline mb-4"><time datetime=2021-08-02 class=text-muted>2021.08.02</time></div><p><strong>Author</strong>: LeoRyu, HuXiaoLiang</p><p><em>éšç€äº‘è®¡ç®—åŠäº‘åŸç”ŸæŠ€æœ¯åœ¨å„ä¸ªé¢†åŸŸå†…çš„é€æ­¥æ™®åŠï¼ŒåŸºäº Kubernetes çš„æ··åˆäº‘ç›¸å…³æ¦‚å¿µå’Œé¡¹ç›®è¶Šæ¥è¶Šå—åˆ°äººä»¬çš„å…³æ³¨ã€‚ä»¥æ··åˆäº‘å½¢æ€éƒ¨ç½²ä¼ä¸šçš„ä¸šåŠ¡æœåŠ¡ï¼Œåœ¨ç†è®ºä¸Šå¯ä»¥æœ€å¤§åŒ–åˆ©ç”¨ç°æœ‰èµ„æºï¼Œå½¢æˆå·®å¼‚äº’è¡¥å’Œæˆæœ¬ä¼˜åŒ–ã€‚ä»¥äº‘è®¡ç®—åŠäº‘åŸç”ŸæŠ€æœ¯ä½œä¸ºåŸºç¡€è®¾æ–½çš„ä¼ä¸šå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ç§æ˜¯å·²ç»æœ‰å­˜é‡ IDC çš„ä¼ä¸šï¼Œä¸€ç§æ˜¯ä¸šåŠ¡å…¨é¢ä½¿ç”¨å…¬æœ‰äº‘çš„ä¼ä¸šã€‚ä»å·²ç»æœ‰å­˜é‡ IDC çš„ä¼ä¸šè§’åº¦è€ƒè™‘ï¼Œæ··åˆäº‘å¯ä»¥æœ€å¤§åŒ–åˆ©ç”¨ç°æœ‰IDCèµ„æºçš„åŒæ—¶ï¼Œæ—¢å¯ä»¥å‘æŒ¥ IDC çš„çµæ´»å®‰å…¨èƒ½åŠ›ï¼Œä¹Ÿå¯ä»¥äº«å—åˆ°å…¬æœ‰äº‘çš„é«˜æ€§ä»·æ¯”ä¼˜åŠ¿ï¼›ä»ä¸šåŠ¡å…¨é¢ä½¿ç”¨å…¬æœ‰äº‘çš„ä¼ä¸šè§’åº¦è€ƒè™‘ï¼Œæ··åˆäº‘åœ¨ä¸ºä¼ä¸šæä¾›ä¸åŒäº‘æœåŠ¡å•†çš„å·®å¼‚èƒ½åŠ›çš„åŒæ—¶ï¼Œä¹Ÿå‡å°‘äº†ä¼ä¸šç»‘å®šå•ä¸€äº‘æœåŠ¡å•†çš„æ½œåœ¨é£é™©ã€‚å°½ç®¡æ··åˆäº‘çš„æ„¿æ™¯æ˜¯ç¾å¥½çš„ï¼Œä½†èµ°å‘è¿™æ„¿æ™¯çš„è·¯å¹¶éç®€å•ã€‚æœ¬æ–‡å°†ç€é‡ä»‹ç» TKEStack æä¾›æ··åˆäº‘èƒ½åŠ›çš„é“è·¯ä¸Šï¼Œåœ¨ç»Ÿä¸€æ“ä½œç³»ç»Ÿç‰ˆæœ¬ã€ Kubernetes ç‰ˆæœ¬ã€å®¹å™¨è¿è¡Œæ—¶å’Œç”¨æˆ·äº¤äº’ä¸Šé‡åˆ°çš„å›°å¢ƒä¸è§£å†³æ–¹æ¡ˆã€‚</em></p><h2 id=ä¸ç»Ÿä¸€å¸¦æ¥çš„é—®é¢˜>ä¸ç»Ÿä¸€å¸¦æ¥çš„é—®é¢˜</h2><h3 id=å®‰å…¨é£é™©>å®‰å…¨é£é™©</h3><p>åœ¨ Linux å’Œ Kubernetes å—åˆ°å¹¿æ³›å…³æ³¨çš„ä»Šå¤©ï¼Œå…¶å®‰å…¨é—®é¢˜çš„å½±å“èŒƒå›´ä¹Ÿè¶Šæ¥è¶Šå¤§ã€‚ä¾‹å¦‚ 2018 å¹´çˆ†å‡ºçš„ç‰¹æ–¯æ‹‰å…¬å¸è®¡ç®—åŸºç¡€è®¾æ–½è¢«é»‘å®¢å…¥ä¾µç”¨æ¥æŒ–çŸ¿çš„äº‹ä»¶<sup>[1]</sup>ï¼Œå°±æ˜¯å› ä¸ºç‰¹æ–¯æ‹‰åœ¨äºšé©¬é€Š AWS ä¸Šçš„ Kubernetes å®¹å™¨é›†ç¾¤è®¿é—®æƒé™æ²¡æœ‰å¾—åˆ°å¦¥å–„ä¿æŠ¤ï¼Œå¯¼è‡´å­˜å‚¨åœ¨S3ç½‘ç»œå­˜å‚¨æ¡¶ä¸Šçš„ä¸€äº›æ•æ„ŸæŠ€æœ¯æ•°æ®ï¼Œä¾‹å¦‚é¥æµ‹æŠ€æœ¯ï¼Œè¢«çªƒå–ã€‚</p><p>æ ¹æ® Palo Alto Networks å…¬å¸ Unit 42 å›¢é˜Ÿçš„ç ”ç©¶æŠ¥å‘Šï¼Œåœ¨ 2018 å¹´ 1 æœˆè‡³ 2019 å¹´ 6 æœˆä¹‹é—´ï¼Œæœ‰2ä¸‡å¤šä¸ªåŸºäº Kubernetes çš„å®¹å™¨å¹³å°è¢«æš´éœ²ï¼Œä¸‹å›¾ä¸ºè¿™äº›è¢«æš´éœ²å¹³å°åœ¨å…¨çƒèŒƒå›´å†…çš„ç»Ÿè®¡æ•°æ®<sup>[2]</sup>ï¼š</p><img alt=è¢«æš´éœ²çš„å¹³å°ç»Ÿè®¡ width=100% src=exposed-k8s.png><p>è¯¥æŠ¥å‘Šä¸­è¿˜ç»Ÿè®¡äº†å„äº‘æœåŠ¡æä¾›å•†å¹³å°ä¸Šå‘ç°çš„æ¼æ´ï¼šäºšé©¬é€Š AWS å¹³å°ä¸Šè¢«å‘ç°è¶…è¿‡ 2900 ä¸‡ä¸ªæ¼æ´ï¼Œè°·æ­Œäº‘å‘ç°çš„æ¼æ´æ•°é‡æ¥è¿‘ 400 ä¸‡ï¼Œå¾®è½¯ Azure å‘ç°äº† 170 ä¸‡å·¦å³æ¼æ´ã€‚</p><p>è¿™äº›æ¼æ´åˆ†å¸ƒåœ¨å„ç§æ“ä½œç³»ç»Ÿç‰ˆæœ¬ã€Kubernetes å‘è¡Œç‰ˆæœ¬ã€å®¹å™¨è¿è¡Œæ—¶ä¹ƒè‡³ç”¨æˆ·äº¤äº’çš„å‰ç«¯ç›¸å…³ä»£ç ä¸­ã€‚è¿™äº›å…³é”®è¦ç´ çš„ä¸ç»Ÿä¸€åœ¨å®¢è§‚ä¸Šä¸ºè¿™äº›å®‰å…¨æ¼æ´æä¾›äº†æ¸©åºŠã€‚</p><h3 id=è¿ç»´æˆæœ¬>è¿ç»´æˆæœ¬</h3><p>ä¸ç»Ÿä¸€ä¹Ÿä¼šä½¿å¾—ç”¨æˆ·çš„è¿ç»´æˆæœ¬å˜å¾—å¾ˆé«˜ã€‚ä¾‹å¦‚å½“å‰ TKEStack åœ¨æ··åˆäº‘åœºæ™¯ä¸»æ¨çš„ç½‘ç»œæ–¹æ¡ˆ Ciliumï¼Œå…¶å¾ˆå¤šç‰¹æ€§éƒ½è¦æ±‚åœ¨ç‰¹å®šçš„å†…æ ¸ç‰ˆæœ¬ä»¥ä¸Šæ‰æ”¯æŒå¼€å¯ï¼Œä¸‹å›¾æ˜¯ Cilium ä¸åŒç‰¹æ€§å¯¹å†…æ ¸ç‰ˆæœ¬è¦æ±‚çš„ç»Ÿè®¡<sup>[3]</sup>ï¼š</p><img alt=Ciliumç‰¹æ€§å†…æ ¸ç‰ˆæœ¬è¦æ±‚ width=100% src=required-kernel-version.png><p>è€Œ Kubernetes ç‰ˆæœ¬å°½ç®¡å£°æ˜ patch ç‰ˆæœ¬ä¸Šä¸‹å…¼å®¹ï¼Œä½†å®é™…ä¸Šåœ¨å„ç‰ˆæœ¬é—´ API èµ„æºå¯¹è±¡çš„è½¬æ¢æ–¹é¢å¯èƒ½å­˜åœ¨å…¼å®¹é—®é¢˜ã€‚ä¾‹å¦‚ TKEStack åœ¨å‡çº§ Kubernetes API ç‰ˆæœ¬æ—¶å°±å‘ç° <code>url.Values</code> éšå¼è‡ªåŠ¨è½¬æ¢ä¸º Kubernetes å¯¹è±¡å·²ç»è¢«åºŸå¼ƒ<sup>[4]</sup>ï¼Œå¯¼è‡´å¾ˆå¤šæ¥å£æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚</p><p>éšç€ä¸šåŠ¡çš„è¿è¡Œæ—¶é—´æ‹‰é•¿å’Œä¸æ–­è¿­ä»£ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿã€Kubernetesã€å®¹å™¨è¿è¡Œæ—¶å’Œ UI çš„ä¸ç»Ÿä¸€é€ æˆçš„è¿ç»´æˆæœ¬ï¼Œä¹Ÿä¼šéšç€æ—¶é—´çš„æ¨ç§»è¶Šå †è¶Šé«˜ã€‚</p><h2 id=tkestack-ç¤¾åŒºä¸ºç»Ÿä¸€æ“ä½œç³»ç»Ÿå’Œ-kubernetes-ç‰ˆæœ¬åšå‡ºçš„åŠªåŠ›>TKEStack ç¤¾åŒºä¸ºç»Ÿä¸€æ“ä½œç³»ç»Ÿå’Œ Kubernetes ç‰ˆæœ¬åšå‡ºçš„åŠªåŠ›</h2><h3 id=æ¨èä½¿ç”¨-tencentos-server>æ¨èä½¿ç”¨ TencentOS Server</h3><p>TencentOS Server åˆå Tencent Linuxï¼Œç®€ç§° Tlinux æ˜¯è…¾è®¯é’ˆå¯¹äº‘åœºæ™¯ç ”å‘çš„ Linux æ“ä½œç³»ç»Ÿï¼Œæä¾›äº†ä¸“é—¨çš„åŠŸèƒ½ç‰¹æ€§å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œä¸ºäº‘æœåŠ¡å™¨å®ä¾‹ä¸­çš„åº”ç”¨ç¨‹åºæä¾›é«˜æ€§èƒ½ï¼Œä¸”æ›´åŠ å®‰å…¨å¯é çš„è¿è¡Œç¯å¢ƒ<sup>[5]</sup>ã€‚</p><img alt=TencentOS width=100% src=tencentos-logo.png><p>ä½œä¸ºä¸€ä¸ªLinuxå‘è¡Œç‰ˆï¼ŒTlinuxæ‹¥æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ol><li><p>å†…æ ¸å®šåˆ¶ï¼ŒåŸºäºå†…æ ¸ç¤¾åŒºé•¿æœŸæ”¯æŒçš„4.14.105ç‰ˆæœ¬å®šåˆ¶è€Œæˆï¼Œå¢åŠ é€‚ç”¨äºäº‘åœºæ™¯çš„æ–°ç‰¹æ€§ã€æ”¹è¿›å†…æ ¸æ€§èƒ½å¹¶ä¿®å¤é‡å¤§ç¼ºé™·ã€‚</p></li><li><p>å®¹å™¨æ”¯æŒï¼Œé’ˆå¯¹å®¹å™¨åœºæ™¯è¿›è¡Œä¼˜åŒ–ï¼Œæä¾›äº†éš”ç¦»å¢å¼ºå’Œæ€§èƒ½ä¼˜åŒ–ç‰¹æ€§ï¼šmeminfoã€vmstatã€cpuinfoã€statã€loadavg, uptime, diskstatsã€‚</p></li><li><p>æ€§èƒ½ä¼˜åŒ–ï¼Œè®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œå­ç³»ç»Ÿå‡ç»è¿‡ä¼˜åŒ–ï¼ŒåŒ…æ‹¬ï¼šä¼˜åŒ– xfs å†…å­˜åˆ†é…ï¼Œè§£å†³ xfs kmem_alloc åˆ†é…å¤±è´¥å‘Šè­¦ä¼˜åŒ–ç½‘ç»œæ”¶åŒ…å¤§å†…å­˜åˆ†é…é—®é¢˜ï¼Œè§£å†³ UDP åŒ…é‡å¤§æ—¶ï¼Œå æ®è¿‡å¤šå†…å­˜é—®é¢˜é™åˆ¶ç³»ç»Ÿ page cache å ç”¨å†…å­˜æ¯”ä¾‹ï¼Œä»è€Œé¿å…å†…å­˜ä¸è¶³å½±å“ä¸šåŠ¡çš„æ€§èƒ½æˆ–è€… OOMã€‚</p></li><li><p>ç¼ºé™·æ”¯æŒï¼Œæä¾›æ“ä½œç³»ç»Ÿå´©æºƒåçš„ kdump å†…æ ¸è½¬å‚¨èƒ½åŠ›æä¾›å†…æ ¸çš„çƒ­è¡¥ä¸å‡çº§èƒ½åŠ›ã€‚</p></li><li><p>å®‰å…¨æ›´æ–°ï¼Œä¼šå®šæœŸè¿›è¡Œæ›´æ–°ï¼Œå¢å¼ºå®‰å…¨æ€§åŠåŠŸèƒ½ã€‚</p></li><li><p>å…¶ä»–ç‰¹æ€§ï¼Œç¦»çº¿è°ƒåº¦ç®—æ³•(BT)ã€è¿›ç¨‹é˜²gdbã€ARM64çƒ­è¡¥ä¸ã€pagecache limitç­‰ã€‚</p></li></ol><p>åœ¨æ··åˆäº‘åœºæ™¯ä¸‹ TKEStack æ¨èä½¿ç”¨ TencentOS Server ä½œä¸ºåº•å±‚çš„æ“ä½œç³»ç»Ÿï¼Œå®‰å…¨é«˜æ•ˆå¹¶æä¾›äº†å¼ºå¤§çš„äº‘åŸç”Ÿèƒ½åŠ›ï¼Œå…³äº TencentOS Server å¯ä»¥åˆ°é¡¹ç›®ç½‘ç«™ <a href=https://github.com/Tencent/TencentOS-kernel>https://github.com/Tencent/TencentOS-kernel</a> ä»¥äº†è§£æ›´å¤šå†…å®¹ã€‚</p><h3 id=å¼•å…¥-tke-å‘è¡Œç‰ˆåˆ°-tkestack>å¼•å…¥ TKE å‘è¡Œç‰ˆåˆ° TKEStack</h3><p>é•¿ä¹…ä»¥æ¥ï¼ŒTKEStack åªæä¾›äº†åŸç”Ÿ Kubernetes ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œè¿™ä½¿å¾— TKEStack æ‰€èƒ½æä¾›ç»™ç”¨æˆ·çš„èƒ½åŠ›å¸¸å¸¸å—åˆ°åŸç”Ÿ Kubernetes çš„ç°æœ‰èƒ½åŠ›çš„é™åˆ¶ã€‚ä¸ºäº†æ‰“ç ´è¿™ä¸€ç°çŠ¶ï¼ŒTKEStack åœ¨å‰ä¸ä¹…å‘å¸ƒçš„ 1.7 ç‰ˆæœ¬å¼•å…¥äº†ç”±è…¾è®¯äº‘ TKE å‘å¸ƒçš„ Kubernetes å‘è¡Œç‰ˆæœ¬ï¼ŒTKE å‘è¡Œç‰ˆï¼ˆTKE Kubernetes Distroï¼‰ã€‚TKE å‘è¡Œç‰ˆåœ¨ä¿è¯å…¼å®¹æ€§çš„åŸºç¡€ä¸Šï¼Œå¯¹ K8s è¿›è¡Œäº†æ‰©å±•ï¼Œå¹¶ä¸”ä¸è…¾è®¯äº‘ TKE æœåŠ¡ä¿æŒç‰ˆæœ¬ä¸€è‡´ã€‚ç”¨æˆ·å¯ä»¥åœ¨è‡ªå·±çš„ IDC æˆ–è€…æ··åˆäº‘ä¸Šéƒ¨ç½² TKE å‘è¡Œç‰ˆï¼Œä½¿ç”¨å·²æœ‰ä¼ä¸šç”¨æˆ·å¤§è§„æ¨¡éªŒè¯çš„å¯é å®‰å…¨çš„ Kubernetes æœåŠ¡<sup>[6]</sup>ã€‚</p><img alt=TKEå‘è¡Œç‰ˆ width=100% src=tke-distro.png><p>ç›¸æ¯”åŸç”Ÿçš„ Kubernetes ç‰ˆæœ¬ï¼ŒTKE å‘è¡Œç‰ˆä¼˜åŠ¿æœ‰ä¸‹é¢å‡ é¡¹ï¼š</p><ol><li><p>å¤§è§„æ¨¡ç”Ÿäº§é›†ç¾¤éªŒè¯ï¼ŒTKE å‘è¡Œç‰ˆæä¾›ä¸è…¾è®¯äº‘ TKE ç›¸åŒçš„å¯å®‰è£…ç‰ˆæœ¬å’Œå¼€æºä»£ç ï¼ŒåŠŸèƒ½å’Œç¨³å®šæ€§ç»è¿‡å¤§é‡ä¼ä¸šç”¨æˆ·ã€å…¬æœ‰äº‘åŠè‡ªç ”äº‘é”¤ç‚¼ã€‚ç”¨æˆ·å¯ä»¥ä½¿ç”¨æä¾›çš„æºä»£ç å’Œç¼–è¯‘å·¥å…·è¿›è¡Œæ„å»ºå’Œéƒ¨ç½²ã€‚</p></li><li><p>æ— ç¼é›†æˆå…¬æœ‰äº‘ TKEï¼ŒTKE å‘è¡Œç‰ˆå¯æ”¯æŒç”¨æˆ·åœ¨è‡ªå»ºæˆ–è€…æ‰˜ç®¡æœºæˆ¿ï¼Œç‰©ç†æœºæˆ–è€…è™šæœºä¸Šï¼Œè¿è¡Œä¸è…¾è®¯äº‘ TKE å®Œå…¨ä¸€è‡´çš„ K8s æœåŠ¡ã€‚å¹¶ä¸”å¯ä»¥æ— ç¼ä¸è…¾è®¯äº‘ TKE é›†æˆï¼Œç»„å»ºæ··åˆäº‘é›†ç¾¤ã€‚</p></li><li><p>æ›´é•¿æ”¯æŒå‘¨æœŸï¼ŒTKE å‘è¡Œç‰ˆçš„æ”¯æŒå‘¨æœŸæ¯”ç¤¾åŒºç‰ˆæ›´é•¿ã€‚åœ¨ç¤¾åŒºç‰ˆåœæ­¢æ”¯æŒåï¼ŒTKE å‘è¡Œç‰ˆå°†ç»§ç»­å¾—åˆ°æ”¯æŒï¼ŒåŒ…æ‹¬é‡è¦é—®é¢˜ä»¥åŠå®‰å…¨æ¼æ´çš„ä¿®å¤ã€‚</p></li><li><p>æ›´å¤šå®ç”¨èƒ½åŠ›å¢å¼ºï¼ŒTKE å‘è¡Œç‰ˆç»“åˆè…¾è®¯è‡ªèº«ä¸šåŠ¡ç‰¹ç‚¹å’Œç»éªŒï¼Œé’ˆå¯¹éƒ¨åˆ†åœºæ™¯ï¼ˆå¼¹æ€§æ‰©å®¹ã€ç¦»åœ¨çº¿æ··éƒ¨ã€èµ„æºéš”ç¦»ç­‰ï¼‰å®ç°äº†èƒ½åŠ›å¢å¼ºã€‚å¹¶ä¸” TKE å‘è¡Œç‰ˆç´§è·Ÿç¤¾åŒºè¶‹åŠ¿ï¼Œä¸»å¯¼æˆ–æ·±åº¦å‚ä¸ç¤¾åŒº KEP è®¾è®¡ä¸å®ç°ã€‚å¯¹äºæœ‰å®ç”¨ä»·å€¼ KEP ä¼šå…ˆäºç¤¾åŒºæ”¯æŒï¼Œè®©ç”¨æˆ·æå‰äº«å—åˆ°äº‘åŸç”ŸæŠ€æœ¯è¿›æ­¥ã€‚</p></li></ol><p>å…³äº TKE å‘è¡Œç‰ˆçš„æ›´å¤šä¿¡æ¯å¯ä»¥è®¿é—® <a href=https://github.com/tkestack/tke-k8s-distro>https://github.com/tkestack/tke-k8s-distro</a> ä»¥è¿›ä¸€æ­¥äº†è§£ã€‚</p><p>åœ¨ 1.7 ç‰ˆæœ¬ä¸­ TKEStack æ”¯æŒ TKE å‘è¡Œç‰ˆæœ¬å’ŒåŸç”Ÿä¸¤ç§ Kubernetes å‘è¡Œç‰ˆæœ¬ï¼Œç”±äº TKE å‘è¡Œç‰ˆå®Œå…¨å…¼å®¹åŸç”Ÿ Kubernetes å‘è¡Œç‰ˆæœ¬ï¼Œåœ¨åç»­çš„è¿­ä»£ä¸­ TKEStack å°†æœç€åªæºå¸¦ TKE å‘è¡Œç‰ˆçš„æ–¹å‘é€æ­¥å‰è¿›ã€‚</p><h3 id=ä½¿ç”¨-containerd-ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶>ä½¿ç”¨ Containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶</h3><p>2020 å¹´å¹´æœ«ï¼ŒKubernetesç¤¾åŒºå®£å¸ƒé¢„è®¡æœ€æ—©å°†åœ¨2021å¹´æ™šäº›æ—¶å€™å‘å¸ƒçš„ 1.23 ç‰ˆæœ¬ä¸­åºŸå¼ƒdockershim<sup>[7]</sup>ï¼Œè¿™æ„å‘³ç€æœªæ¥çš„ Kubernetes å°†ä¸å†æ”¯æŒä»¥ Docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ã€‚</p><p>TKEStack ç¤¾åŒºç»è¿‡ç ”è®¨è°ƒç ”åï¼Œå†³å®šä½¿ç”¨å’Œè…¾è®¯å…¬æœ‰äº‘ TKE ä¸€è‡´çš„ Containerd ä½œä¸ºæœªæ¥æ›¿ä»£ Docker çš„å®¹å™¨è¿è¡Œæ—¶ã€‚Containerd æ˜¯é™¤ Docker å¤–å½“ä¸‹æœ€ä¸ºæˆç†Ÿç¨³å®šï¼Œå¹¶è¢«å¹¿æ³›æ¥å—çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸‹å›¾æ˜¯ 2021 å¹´å¹´åˆå…³äºå®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨ç‡ç›¸å…³çš„è°ƒæŸ¥ç»Ÿè®¡<sup>[8]</sup>ï¼š</p><img alt=è¿è¡Œæ—¶ä½¿ç”¨ç‡ width=100% src=container-runtimes.png><p>Containerd çš„æ¶æ„æ˜¯ client-server æ¶æ„ï¼Œæ”¯æŒ runcã€Kata Container ç­‰å¤šç§åº•å±‚è¿è¡Œæ—¶ï¼ŒåŒæ—¶åˆæœ‰å¾ˆé«˜çš„æ‰©å±•æ€§ï¼Œä¸‹å›¾ä¸º Containerd çš„æ•´ä½“æ¶æ„å›¾<sup>[9]</sup>ï¼š</p><img alt=containerdæ•´ä½“æ¶æ„ width=100% src=containerd-architecture.png><p>ä½œä¸ºè¿‡æ¸¡æ—¶æœŸï¼Œå¦‚æœç”¨æˆ·é€‰æ‹©çš„ Kubernetes ç‰ˆæœ¬ä¾æ—§æ”¯æŒ dockershimï¼ŒTKEStack å°†å…è®¸ç”¨æˆ·åœ¨åˆ›å»ºé›†ç¾¤æ—¶å†³å®šé€‰æ‹© Docker è¿˜æ˜¯ Containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œå¹¶æä¾›æ–‡æ¡£ï¼Œå¸®åŠ©ç”¨æˆ·å°†å­˜é‡é›†ç¾¤çš„ runtime ä» Docker è¿ç§»åˆ° Containerdã€‚æœªæ¥ï¼ŒTKEStackä¼šç§»é™¤æ‰ Docker çš„ä¾èµ–ï¼Œå…¨é¢å…¼å®¹ç¤¾åŒºçš„ CRI æ ‡å‡†æ¨¡å‹ï¼Œå¹¶å°† Containerd ä½œä¸ºé»˜è®¤çš„ runtime ä¸å…¬æœ‰äº‘ TKE ä¿æŒç»Ÿä¸€ã€‚</p><h3 id=é£æ ¼ç»Ÿä¸€çš„ç”¨æˆ·äº¤äº’>é£æ ¼ç»Ÿä¸€çš„ç”¨æˆ·äº¤äº’</h3><p>ç»Ÿä¸€çš„äº¤äº’é£æ ¼å¯ä»¥å¤§å¤§å‡å°‘ç”¨æˆ·çš„å­¦ä¹ æˆæœ¬å’Œå¿ƒæ™ºè´Ÿæ‹…ã€‚TKEStack ä¸è…¾è®¯å…¬æœ‰äº‘ TKE äº§å“é‡‡ç”¨äº†ç›¸åŒçš„äº¤äº’é£æ ¼ï¼Œç”¨æˆ·åªéœ€è¦é€‚åº”äº†å…¶ä¸­ä¸€ä¸ªçš„äº¤äº’ä¹ æƒ¯ï¼Œå°±å¯ä»¥å‡ ä¹é›¶å­¦ä¹ æˆæœ¬çš„æ“ä½œä½¿ç”¨å¦å¤–ä¸€æ¬¾äº§å“ã€‚ä¸‹å›¾å±•ç¤ºäº† TKEStack å’Œè…¾è®¯å…¬æœ‰äº‘ TKE äº§å“çš„ç”¨æˆ·å‰ç«¯äº¤äº’é¡µé¢ï¼š</p><img alt=containerdæ•´ä½“æ¶æ„ width=100% src=tkestack-and-tke.png><p>TKEStack å’Œè…¾è®¯å…¬æœ‰äº‘ TKE äº§å“ä¸Šæœ‰ç€å¾ˆå¤šç›¸åŒçš„æ¦‚å¿µï¼Œé’ˆå¯¹è¿™äº›æ¦‚å¿µçš„è§†å›¾å±•ç¤ºé€»è¾‘ä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚åœ¨æ··åˆäº‘åœºæ™¯ä¸‹ï¼Œè¿™ç§ä¸€è‡´æ€§å°†äº§ç”Ÿç§¯æçš„åŒ–å­¦ååº”ï¼Œå¯¹ç”¨æˆ·éå¸¸å‹å¥½ï¼Œå¹¶å‡è½»äº†ç»´æŠ¤ä¸Šçš„æˆæœ¬ã€‚</p><p>äº¤äº’çš„ç»Ÿä¸€ä¸ä»…ä»…å¯¹ç”¨æˆ·æœ‰å¾ˆå¤šå¥½å¤„ï¼Œå¯¹åç»­ TKEStack çš„äº§å“è®¾è®¡ï¼Œåå°æ¶æ„æ­å»ºåŠèƒ½åŠ›å®ç°ä¸Šéƒ½æœ‰ç€ç§¯æçš„ä½œç”¨ï¼Œè€Œè¿™ç§ç§¯æä½œç”¨ä¼šä¸º TKEStack åŠ é€Ÿå¸ƒå±€æ··åˆäº‘é¢†åŸŸæä¾›æœ‰åŠ›çš„æ”¯æŒã€‚</p><h2 id=æ€»ç»“>æ€»ç»“</h2><p>æ­£æ‰€è°“å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ï¼Œåªæœ‰ç»Ÿä¸€å·©å›ºä¸€ä¸ªå¼ºå¤§ç¨³å®šçš„å¹³å°åŸºçŸ³ï¼ŒTKEStack æ‰ä¼šåœ¨æä¾›æ··åˆäº‘èƒ½åŠ›çš„é“è·¯ä¸Šè¡Œé©¶çš„æ›´åŠ å¹³ç¨³ã€‚åç»­æˆ‘ä»¬ä¼šåœ¨è¯¥ç³»åˆ—ä¸­ä»‹ç»æ›´å¤šå…³äº TKEStack çš„æ··åˆäº‘èƒ½åŠ›ï¼Œæ•¬è¯·å¤§å®¶æœŸå¾…ã€‚</p><p>æœ€åæ¬¢è¿å¤§å®¶åˆ° TKEStack çš„é¡¹ç›®ä»“åº“ <a href=https://github.com/tkestack/tke>https://github.com/tkestack/tke</a> æå‡ºå»ºè®®è´¡çŒ®åŠ›é‡ï¼Œå¤§å®¶çš„æ”¯æŒå°†ä¼šä»¤ TKEStack é¡¹ç›®å˜å¾—æ›´å¥½ï¼</p><h2 id=å‚è€ƒèµ„æ–™>å‚è€ƒèµ„æ–™</h2><p>[1] Lessons from the Cryptojacking Attack at Tesla [https://redlock.io/blog/cryptojacking-tesla]</p><p>[2] Cloudy with a Chance of Entropy [https://www.paloaltonetworks.com/resources/research/unit42-cloud-with-a-chance-of-entropy]</p><p>[3] Required Kernel Versions for Advanced Features [https://docs.cilium.io/en/v1.10/operations/system_requirements/#required-kernel-versions-for-advanced-features]</p><p>[4] Can no longer call DecodeParameters with url.Values in 1.19.0 client-go [https://github.com/kubernetes/kubernetes/issues/94688]</p><p>[5] è…¾è®¯TencentOS åå¹´äº‘åŸç”Ÿçš„è¿­ä»£æ¼”è¿›ä¹‹è·¯ [https://mp.weixin.qq.com/s/Cbck85WmivAW0mtMYdeEIw]</p><p>[6] è…¾è®¯äº‘äº‘åŸç”Ÿæ··åˆäº‘-TKEå‘è¡Œç‰ˆ [https://mp.weixin.qq.com/s/d7ubPXwtTw8JsFIHp-JXEg]</p><p>[7] Dockershim Deprecation FAQ [https://kubernetes.io/blog/2020/12/02/dockershim-faq/]</p><p>[8] Sysdig 2021 container security and usage report: Shifting left is not enough [https://sysdig.com/blog/sysdig-2021-container-security-usage-report/]</p><p>[9] Introduction and Deep Dive Into Containerd [https://static.sched.com/hosted_files/kccnceu2021/d3/containerd-KubeConEU2021.pdf]</p></div><div class=td-content style=page-break-before:always><h1 id=pg-89581b78a6814df37de4a78cba3ec27f>è…¾è®¯å¼€æºå®¹å™¨äº‘å¹³å° TKEStack ä»‹ç»</h1><div class="td-byline mb-4"><time datetime=2021-06-09 class=text-muted>2021.06.09</time></div><p><strong>Author</strong>: Yingzhe Ru (æ±è‹±å“²)</p><p><em>2019å¹´11æœˆåœ¨è…¾è®¯ Techo å¼€å‘è€…å¤§ä¼šä¸Šï¼ŒTKEStack æ­£å¼å‘å¸ƒå¹¶å®£å¸ƒå¼€æºï¼Œ åŒä¸€æ—¶é—´å‡ç»“ç€è…¾è®¯å¤šå¹´æ¥å®¹å™¨æŠ€æœ¯ç§¯ç´¯çš„ä»£ç ä¹Ÿé€šè¿‡ push å‘½ä»¤ä¸Šä¼ åˆ° githubï¼Œ ä»é‚£ä¸€åˆ»èµ·æˆ‘ä»¬å¼€å¯äº†ä¸€æ®µé¢å‘å¼€æºï¼Œå……æ»¡æœºé‡ä¸æŒ‘æˆ˜ï¼Œé©¶å‘æœªæ¥äº‘ä¸–ç•Œçš„ä¼Ÿå¤§èˆªç¨‹ã€‚ æ—¶é—´å›åˆ°ä»Šå¤©ï¼ŒTKEStack è‡ªå¼€æºåå·²ç»è¿‡å»äº†å‡ ä¸ªæœˆï¼Œè¿­ä»£äº†å¤šä¸ªç‰ˆæœ¬ï¼Œå½“å‰ä»åœ¨ä»¥è¾ƒå¿«çš„é€Ÿåº¦æäº¤ä¿®æ”¹ï¼Œå‘å¸ƒæ›´æ–°ã€‚ éšç€å¼€å‘è¿›åº¦çš„æ¨è¿›ï¼Œäº§å“çš„åŠŸèƒ½é€æ¸å¢å¼ºï¼Œç”¨æˆ·ä½“éªŒæ„ˆå‘çš„å®Œå–„ï¼Œæ•´ä¸ªäº§å“å’ŒæŠ€æœ¯æ ˆçš„è½®å»“ä¹Ÿæ„ˆåŠ çš„æ¸…æ™°ï¼Œ å› æ­¤æœ‰å¿…è¦åœ¨è¿™é‡Œç³»ç»Ÿä»‹ç»ä¸€ä¸‹ TKEStack å®¹å™¨äº‘å¹³å°ï¼Œæ˜ç¡®æˆ‘ä»¬çš„ç›®æ ‡ï¼Œå±•ç¤ºå¹³å°çš„ç‰¹æ€§ä»¥åŠä¸ºæ‚¨æä¾›çš„ä»·å€¼ï¼Œå¸Œæœ›æ‚¨é˜…è¯»å®Œè¿™ç¯‡æ–‡ç« åï¼Œ èƒ½å¤Ÿå¯¹ TKEStack äº§ç”Ÿå…´è¶£ï¼Œäº†è§£åˆ° TKEStack çš„èƒ½åŠ›ï¼Œå¹¶èƒ½å¤Ÿè€ƒè™‘ä½¿ç”¨æˆ–é›†æˆ TKEStack åŠ©åŠ›æ‚¨çš„ä¸šåŠ¡æˆ–å•†ä¸šäº§å“è½åœ°ã€‚</em></p><h2 id=ç®€ä»‹>ç®€ä»‹</h2><p>è¿‘å¹´æ¥åœ¨äº‘è®¡ç®—é¢†åŸŸï¼Œå®¹å™¨æŠ€æœ¯é¢†åŸŸä¸æ–­åˆ›æ–°ï¼Œå›´ç»•å®¹å™¨ä»¥åŠå®¹å™¨ç›¸å…³æŠ€æœ¯æ„å»ºå‡ºäº‘åŸç”Ÿçš„ç”Ÿæ€å’ŒæŠ€æœ¯æ ‡å‡†ã€‚ åŸºäº Kubernetes çš„å®¹å™¨å¹³å°ï¼Œä¸ºå®¹å™¨åŒ–çš„åº”ç”¨æä¾›èµ„æºè°ƒåº¦ã€éƒ¨ç½²è¿è¡Œã€æœåŠ¡å‘ç°å’Œå¼¹æ€§ä¼¸ç¼©ç­‰æ•´ä¸€å¥—åŠŸèƒ½ï¼Œ é€æ­¥æˆä¸ºå®¢æˆ·è½¯ä»¶åŸºç¡€è®¾æ–½çš„ä¸äºŒä¹‹é€‰ã€‚</p><p>è…¾è®¯åœ¨äº‘è®¡ç®—é¢†åŸŸæ·±è€•å¤šå¹´ï¼Œå°¤å…¶åœ¨å®¹å™¨æŠ€æœ¯é¢†åŸŸï¼Œè‡ª2009å¹´å¼€å‘å®¹å™¨è®¡ç®—å¹³å° T-Borg å¼€å§‹ï¼Œ2012å¹´å¼€å‘å†…éƒ¨çš„ç¦»çº¿åœ¨çº¿æ··åˆéƒ¨ç½²çš„å®¹å™¨å¹³å° Torcaï¼Œ2013ã€2014å¹´ Docker å’Œ Kubernetes å‡ºç°åï¼Œè…¾è®¯è¿…é€Ÿåˆ‡æ¢è‡ªç ”æ–¹æ¡ˆåˆ°å¼€æºæ–¹æ¡ˆï¼Œå¯¹å¤–æ¨å‡ºå•†ç”¨å…¬æœ‰äº‘ç‰ˆæœ¬æœåŠ¡TKEå’Œç§æœ‰äº‘ç‰ˆæœ¬ GaiaStackã€‚2019å¹´ï¼Œå…¬æœ‰äº‘å’Œç§æœ‰äº‘ç‰ˆæœ¬åˆå¹¶ä¸ºç»Ÿä¸€æ¶æ„å’Œæ–¹æ¡ˆ TKEï¼Œå¹¶æ¨å‡ºäº†ç¤¾åŒºå‘è¡Œç‰ˆ TKEStackã€‚</p><p>TKEStackæ˜¯è…¾è®¯å†…éƒ¨å‡ å¤§å›¢é˜ŸåˆåŠ›æ‰“é€ çš„å¼€æºç‰ˆæœ¬ï¼Œæ€»ç»“äº†å¤šå¹´æ¥è…¾è®¯åœ¨äº‘åŸç”Ÿé¢†åŸŸçš„ç»éªŒå’ŒæŠ€æœ¯ç§¯ç´¯ï¼Œå¸æ”¶äº† Gaia å¹³å°ã€TKEå…¬æœ‰äº‘ä»¥åŠè…¾è®¯å†…éƒ¨ä¼—å¤šå®¹å™¨äº§å“çš„ä¼˜ç‚¹ï¼Œå…¨æ–°æ‰“é€ çš„é¢å‘ç§æœ‰äº‘ä¸šåŠ¡åœºæ™¯çš„å¼€æºå®¹å™¨å¹³å°ã€‚TKEStack ä»¥é«˜èµ·ç‚¹èµ·æ­¥ï¼Œç”©æ‰å¤§é‡å†å²é—ç•™åŒ…è¢±ï¼Œä»æ¶æ„ä¸Šé‡æ–°è®¾è®¡ï¼Œå¹¶ä¸”ç»“åˆä¸šå†…ç”Ÿæ€æœ€æ–°çš„æ›´æ–°å’Œç‰¹æ€§ï¼Œä½¿å¾—TKEStackè½»è£…ä¸Šé˜µï¼Œç”¨æˆ·å¼€ç®±å³ç”¨æœ€æ–°çš„äº‘åŸç”Ÿèƒ½åŠ›ã€‚</p><p>TKEStack åç§°ä¸­åŒ…å« Stackï¼Œä¹Ÿè¡¨æ˜ TKEStack æœ‰åˆ«äºå…¶ä»–å®¹å™¨äº§å“ï¼Œå®ƒå°†æ‰“é€ çš„æ˜¯ä¸€æ•´å¥—æŠ€æœ¯æ ˆï¼Œä»¥ TKE å®¹å™¨å¹³å°ä¸ºæ ¸å¿ƒï¼Œé¢å‘ç½‘ç»œï¼Œå­˜å‚¨ï¼Œåº”ç”¨ï¼ŒæœåŠ¡ç­‰å„ä¸ªé¢†åŸŸï¼Œæ‰©å±•å¹³å°åœ¨åº•å±‚èµ„æºç®¡æ§å’Œä¸Šå±‚ä¸šåŠ¡æœåŠ¡ä¸Šçš„èƒ½åŠ›è¾¹ç•Œï¼Œæ‰€æœ‰è¿™äº›èƒ½åŠ›éƒ½å°†åœ¨ TKEStack ä¸‹å¼€æºï¼Œç¤¾åŒºç”¨æˆ·ã€åˆä½œä¼™ä¼´ç­‰éƒ½å¯ä»¥å‚ä¸è¿›æ¥è´¡çŒ®å’Œåˆ†äº«ã€‚</p><h2 id=æ„¿æ™¯ä¸ç›®æ ‡>æ„¿æ™¯ä¸ç›®æ ‡</h2><p>æœªæ¥äº‘è®¡ç®—åŸºç¡€è®¾æ–½ä¸€å®šå¤„äºå¤šç»´å¼‚æ„çš„çŠ¶æ€ï¼Œæœªæ¥å®¢æˆ·ä¹Ÿä¼šå¤„äºå¤šç»´å¼‚æ„çš„ä¸šåŠ¡åœºæ™¯ï¼ŒåŒ…æ‹¬ç¡¬ä»¶å¼‚æ„ã€åŸºç¡€æ¶æ„å¼‚æ„å’Œä¸šåŠ¡å¹³å°å¼‚æ„ã€‚</p><ul><li>ç¡¬ä»¶å¼‚æ„ - éšç€å›½äº§åŒ–åœ¨å›½å†…çš„å‘å±•ï¼Œå°†æ¥å®¢æˆ·çš„æœåŠ¡å™¨æ¶æ„å°†ä¼šæ˜¯ x86 å’Œ arm64 æ··æ‚åœ¨ä¸€èµ·ï¼›éšç€AIè®¡ç®—å‘å±•ï¼ŒIntel ç­‰å‚å•†ä¹ŸåŠ å…¥åˆ° GPU çš„ç«äº‰ä¸­ï¼Œå†åŠ ä¸Š ARM å¹³å°çš„ GPU å’Œ FPGA ç­‰ç¡¬ä»¶ï¼Œè®¡ç®—é¢†åŸŸçš„ç¡¬ä»¶å°†æ›´åŠ ç¢ç‰‡åŒ–ã€‚</li><li>åŸºç¡€æ¶æ„å¼‚æ„ - æœªæ¥çš„æ•°å­—åŒ–è®¡ç®—æœåŠ¡ä¸­å¿ƒï¼Œå°¤å…¶åœ¨å›½å†…ï¼Œå°†æ›´å¤šä¼šé‡‡ç”¨ç§æœ‰åŒ–(æˆ–ä¸“æœ‰äº‘)å’Œå…¬æœ‰äº‘æ··åˆéƒ¨ç½²çš„æ¨¡å‹æ”¯æŒä¸šåŠ¡å‘å±•ã€‚</li><li>ä¸šåŠ¡å¹³å°å¼‚æ„ - ä¼ ç»Ÿä¸šåŠ¡åœ¨æ— æ³•å…¨éƒ¨è¿ç§»ä¸‹çš„æƒ…å†µï¼Œé•¿æœŸä¼šå’Œå¾®æœåŠ¡ã€Service Mesh ã€Serverlessç­‰æŠ€æœ¯ç»„æˆä¸€ä¸ªå¼‚æ„çš„ä¸šåŠ¡å¤§ä¸­å°ï¼ŒåŒæ—¶è¿˜è¦æ”¯æ’‘ä½¿ç”¨ Sparkã€Hadoopã€TensorFlowã€PyTorch ç­‰è®¡ç®—å¹³å°è¿è¡Œã€‚</li></ul><p>æˆ‘ä»¬çš„æ„¿æ™¯æ˜¯ä¸ºå†…éƒ¨ä¸šåŠ¡å’Œå¤–éƒ¨å•†ä¸šå®¢æˆ·æä¾›ç¦»çº¿è®¡ç®—ä¸šåŠ¡å’Œåœ¨çº¿æœåŠ¡ä¸šåŠ¡æ··åˆéƒ¨ç½²çš„ä¸€ç«™å¼é€šç”¨åŸºç¡€æ¶æ„å¹³å°ã€‚ åŸºäºæ­¤æ„¿æ™¯ï¼ŒTKEStack å°†ç»§æ‰¿è…¾è®¯å†…éƒ¨å®¹å™¨æŠ€æœ¯ä¼˜åŠ¿ï¼Œä¸ºç”¨æˆ·ã€ä¸ºåˆä½œä¼™ä¼´ã€ä¸ºç”Ÿæ€åˆ›é€ ä»·å€¼ï¼Œç”Ÿæ€å…±å»ºï¼Œäº§ä¸šå…±åˆ›ã€‚</p><ul><li>é¢å‘ç”¨æˆ· - ä¸ºç”¨æˆ·æä¾›ç¨³å®šé«˜æ•ˆå¯æ‰©å±•çš„å®¹å™¨æœåŠ¡äº§å“ï¼Œæä¾›ä¾¿æ·çš„å®‰è£…éƒ¨ç½²ã€ç®€æ´çš„ç®¡æ§å’Œèµ„æºç®¡ç†ï¼Œä»¥åŠå®Œå–„çš„è¿ç»´å·¥å…·æ”¯æŒï¼Œæ»¡è¶³ä¸šåŠ¡ä¸Šäº‘éœ€æ±‚ã€‚</li><li>é¢å‘åˆä½œä¼™ä¼´ - ä¸ºä¸‹æ¸¸äº§å“æä¾›è°ƒåº¦èƒ½åŠ›å¼ºå¤§ã€åŠŸèƒ½ä¸°å¯Œã€æ€§èƒ½ç¨³å®šçš„å®¹å™¨åº•åº§ï¼Œä½¿ç”¨æˆ·èƒ½åŸºäº TKEStack ä¾¿æ·æ‰“é€ æ˜“éƒ¨ç½²ã€æ˜“ç»´æŠ¤ã€æ˜“æ‰©å±•çš„äº§å“å’ŒæœåŠ¡ï¼Œåœ¨äº’è”ç½‘ã€ä¼ ç»Ÿè¡Œä¸šä¸æ”¿ä¼ç­‰é¢†åŸŸæä¾›æœ‰é’ˆå¯¹æ€§çš„è¡Œä¸šè§£å†³æ–¹æ¡ˆã€‚</li><li>é¢å‘ç”Ÿæ€ - å›´ç»•å®¹å™¨ç”Ÿæ€çš„å„ç§èƒ½åŠ›ï¼Œç»Ÿä¸€åº”ç”¨æœåŠ¡çš„å®šä¹‰ï¼Œå‘å¸ƒã€é…ç½®ã€å‡çº§åŠè¿ç»´æ•´ä¸ªç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæ•´åˆä¸­é—´ä»¶ã€è¿è¡Œæ—¶ã€å­˜å‚¨ã€ç½‘ç»œèƒ½åŠ›ï¼Œé€æ­¥å»ºç«‹èµ·ä¸€ä¸ªåŸºäºäº‘åŸç”Ÿçš„å®¹å™¨å¹³å°æ ‡å‡†ã€‚</li></ul><h2 id=æ•´ä½“æ¶æ„>æ•´ä½“æ¶æ„</h2><p>TKEStackæ•´ä½“æ¶æ„ä¸Šé‡‡ç”¨ Kubernetes on Kubernetes çš„è®¾è®¡ç†å¿µï¼Œå……åˆ†æ»¡è¶³å¹³å°æœåŠ¡çš„é«˜å¯ç”¨æ€§å’Œæ‰©å±•æ€§ã€‚</p><img alt=TKEStackæ•´ä½“æ¶æ„ width=100% src="tkestack_ infrastructure.png"><ul><li>Global: é›†ç¾¤è´Ÿè´£è¿è¡Œæ•´ä¸ª TKEStack å¹³å°è‡ªèº«æ‰€éœ€ç»„ä»¶ï¼›</li><li>Cluster: ä¸šåŠ¡é›†ç¾¤æ˜¯ç”± TKEStack æ§åˆ¶å°ç»Ÿä¸€ç®¡ç†ï¼Œè´Ÿè´£è¿è¡Œä¸šåŠ¡ï¼›</li><li>Installer: è´Ÿè½½å®‰è£… Global é›†ç¾¤å’Œç®¡æ§ç»„ä»¶ï¼›</li><li>Auth: æƒé™è®¤è¯ç»„ä»¶ï¼Œæä¾›ç”¨æˆ·è®¤è¯ã€æˆæƒç›¸å…³åŠŸèƒ½ï¼›</li><li>Gateway: ç½‘å…³ç»„ä»¶ï¼Œå¹¶è¿è¡Œæ§åˆ¶å°çš„ Web ç•Œé¢æœåŠ¡ï¼›</li><li>Platform: å¹³å°ç®¡ç†ç»„ä»¶ï¼Œæä¾›åŒ…å«é›†ç¾¤ç®¡ç†ç­‰åŠŸèƒ½çš„å¹³å°æœåŠ¡ï¼›</li><li>Business: ä¸šåŠ¡ç®¡ç†ç»„ä»¶ï¼Œæä¾›ä¸šåŠ¡ç®¡ç†ç›¸å…³åŠŸèƒ½çš„åå°æœåŠ¡ï¼›</li><li>Monitor: ç›‘æ§æœåŠ¡ç»„ä»¶ï¼Œæä¾›ç›‘æ§é‡‡é›†ã€ä¸ŠæŠ¥ã€å‘Šè­¦ç›¸å…³æœåŠ¡ï¼›</li><li>Notify: é€šçŸ¥åŠŸèƒ½ç»„ä»¶ï¼Œæä¾›æ¶ˆæ¯é€šçŸ¥ç›¸å…³çš„åŠŸèƒ½ï¼›</li><li>Registry: é•œåƒæœåŠ¡ç»„ä»¶ï¼Œæä¾›å¹³å°é•œåƒä»“åº“å’Œ charts ä»“åº“æœåŠ¡ï¼›</li><li>Galaxy: ç½‘ç»œæ’ä»¶ï¼Œä¸ºé›†ç¾¤æä¾›å¤šç§ç½‘ç»œæ¨¡å¼æœåŠ¡ï¼›</li><li>Logagent: æ—¥å¿—ç®¡ç†ç»„ä»¶ï¼Œä¸ºå¹³å°æä¾›æ—¥å¿—ç®¡ç†ç›¸å…³æœåŠ¡ï¼›</li><li>Audit: è®¾è®¡ç»„ä»¶ï¼Œæä¾›å®¡è®¡æœåŠ¡åŠŸèƒ½ï¼›</li></ul><p>Global é›†ç¾¤æä¾›å®¹å™¨äº‘å¹³å°çš„æ”¯æ’‘ç¯å¢ƒå’Œè¿è¡Œè‡ªèº«æ‰€éœ€çš„å„ç§ç»„ä»¶ï¼ŒåŒ…æ‹¬ä¸šåŠ¡ç®¡ç†ç»„ä»¶ã€å¹³å°ç®¡ç†ç»„ä»¶ã€æƒé™è®¤è¯ç»„ä»¶ã€ç›‘æ§å’Œå‘Šè­¦ç»„ä»¶ã€registry é•œåƒä»“åº“ç»„ä»¶ä»¥åŠ gateway å‰ç«¯é¡µé¢ç½‘å…³ç»„ä»¶ç­‰ç­‰ã€‚å„ä¸ªç»„ä»¶ä»¥ workload çš„å½¢å¼çµæ´»éƒ¨ç½²åœ¨ global é›†ç¾¤ä¸­ï¼Œå„ç»„ä»¶å¤šå‰¯æœ¬é«˜å¯ç”¨æ–¹å¼éƒ¨ç½²ï¼Œå•ä¸ªç»„ä»¶å¼‚å¸¸æˆ–è€…ä¸»æœºèŠ‚ç‚¹æ‰çº¿ç­‰æ•…éšœä¸ä¼šå½±å“globalé›†ç¾¤çš„æ­£å¸¸è¿è¡Œï¼ŒTKEStackä»å¯æä¾›çš„ç®¡ç†åŠŸèƒ½ï¼Œç”¨æˆ·æ­£å¸¸çš„ä¸šåŠ¡è®¿é—®ä¸å—å½±å“ã€‚</p><p>åœ¨æ‰©å±•æ€§æ–¹é¢ï¼Œæ ¹æ®ä¸åŒåœºæ™¯çµæ´»é…ç½®é›†ç¾¤ï¼Œä¾‹å¦‚ä¸ºæ‰¿è½½å¤§æµé‡é«˜å¯é æ€§çš„åœ¨çº¿ä¸šåŠ¡ï¼Œæœ‰å¿…è¦æé«˜ global é›†ç¾¤çš„è§„æ ¼é…ç½®ï¼Œä½¿å…¶èƒ½å¤Ÿç®¡ç†å¤§è§„æ¨¡æµ·é‡çš„ä¸šåŠ¡é›†ç¾¤åŠåº”ç”¨èµ„æºï¼›å¦‚æœé¢å‘ä¸ªäººå¼€å‘è€…æˆ–ä¸­å°å‹ä¸šåŠ¡ï¼Œç”šè‡³å¯ä»¥ç®€åŒ–ä¸ºä»…æ•°ä¸ªèŠ‚ç‚¹ç»„æˆçš„ global é›†ç¾¤ï¼Œå¹¶é€šè¿‡è¯¥é›†ç¾¤æ‰¿è½½ä¸šåŠ¡ã€‚</p><h2 id=èƒ½åŠ›ç‰¹æ€§>èƒ½åŠ›ç‰¹æ€§</h2><p>é€šè¿‡é›†æˆå’Œä½¿ç”¨ TKEStackï¼Œä¸ä»…æ”¯æŒ K8S åŸç”Ÿçš„èµ„æºè°ƒåº¦ã€éƒ¨ç½²è¿è¡Œã€æœåŠ¡å‘ç°å’Œå¼¹æ€§ä¼¸ç¼©ç­‰æ•´ä¸€å¥—åŠŸèƒ½ï¼ŒTKEStack è¿˜æ”¯æŒå¤šç§ç‰¹æ€§ï¼Œæ–¹ä¾¿ç”¨æˆ·æ¥å…¥å’Œä½¿ç”¨ï¼Œé€šè¿‡çµæ´»çš„æ‰©å±•åŠŸèƒ½å®ç°è‡ªèº«æœåŠ¡çš„å¢å€¼ã€‚</p><h3 id=åŸç”Ÿæ”¯æŒ>åŸç”Ÿæ”¯æŒ</h3><p>TKEStackæ˜¯ä¸€æ¬¾ä¸“æ³¨äº Kubernetes æŠ€æœ¯æ ˆçš„ï¼Œé›†æ˜“ç”¨æ€§ä¸æ‰©å±•æ€§äºä¸€èº«çš„ K8S å‘è¡Œç‰ˆï¼Œç¬¦åˆKubernetesæ¥å£æ ‡å‡†ï¼Œäº§å“åº•å±‚å®Œå…¨å…¼å®¹æ ‡å‡† Kubernetesã€‚å› æ­¤ï¼ŒåŸºäº Kubernetes ç”Ÿæ€çš„åº”ç”¨å’ŒæœåŠ¡éƒ½å¯ä»¥æ— ç¼è¿ç§»åˆ°TKEStackä¸Šæ¥ï¼Œæœ‰æ ‡å‡†K8Sè¿ç»´ç®¡ç†ç»éªŒçš„ç”¨æˆ·å¯ä»¥å¹³æ»‘çš„åˆ‡æ¢åˆ° TKEStack å¹³å°ã€‚</p><p>TKEStack è·Ÿéšæœ€æ–° k8s ç‰ˆæœ¬ï¼Œæ”¯æŒæ‰€æœ‰å¯ç”¨çš„åŠŸèƒ½å’Œå®‰å…¨è¡¥ä¸ï¼Œé€šè¿‡çµæ´»çš„é›†ç¾¤ç®¡ç†åŠŸèƒ½ï¼Œæ–¹ä¾¿çš„å¯¹é›†ç¾¤è¿›è¡Œæ›´æ–°å‡çº§æ“ä½œï¼Œå¸®åŠ©ç”¨æˆ·ä½“éªŒå’Œä½¿ç”¨æœ€æ–°çš„ç”Ÿæ€æŠ€æœ¯ã€‚ä½œä¸ºäº‘åŸç”Ÿçš„åŸºç¡€è®¾æ–½å¹³å°ï¼Œä»»ä½•ç¬¦åˆäº‘åŸç”Ÿè§„èŒƒå’Œæ ‡å‡†çš„åº”ç”¨æˆ–é¡¹ç›®ï¼Œéƒ½å¯ä»¥æ„å»ºå’Œè¿è¡Œåœ¨ TKEStack ä¸­ã€‚</p><h3 id=ç®€å•æ˜“ç”¨>ç®€å•æ˜“ç”¨</h3><p>æä¾›å’Œè…¾è®¯å…¬æœ‰äº‘ç‰ˆä¸€è‡´çš„ UIï¼Œç•Œé¢ç®€æ´å‹å¥½ï¼Œæ”¯æŒé…ç½®å„ç§ K8S èµ„æºï¼Œæ–¹ä¾¿ç”¨æˆ·é¡ºåˆ©çš„åˆ›å»ºå’Œç®¡ç†å®¹å™¨åº”ç”¨ï¼Œé™ä½äº†å®¹å™¨å¹³å°çš„å­¦ä¹ å’Œæ“ä½œæˆæœ¬ã€‚TKEStack è¿˜æœ‰ç€å®Œå–„çš„é•œåƒä»“åº“å’Œåº”ç”¨å•†åº—åŠŸèƒ½ï¼Œå†…éƒ¨åŒ…å«è…¾è®¯ä¼˜ç§€çš„å¼€æºå®¹å™¨åº”ç”¨æ¨¡æ¿ï¼Œæ–¹ä¾¿ç”¨æˆ·ä¸€é”®éƒ¨ç½²é«˜è´¨é‡ç¨³å®šçš„åº”ç”¨æœåŠ¡ã€‚</p><h3 id=å¤šé›†ç¾¤ç®¡ç†>å¤šé›†ç¾¤ç®¡ç†</h3><p>æ”¯æŒæ–°å»ºç‹¬ç«‹é›†ç¾¤æˆ–çº³ç®¡ä¸åŒåŸºç¡€è®¾æ–½ä¸Šçš„å·²æœ‰ Kubernetes é›†ç¾¤ï¼Œé€šè¿‡é¡µé¢æˆ–å‘½ä»¤è¡Œé›†ä¸­ç®¡ç†å¤šä¸ªé›†ç¾¤ï¼Œå®ç°äº†æ··åˆäº‘åœºæ™¯ä¸‹çš„å¤šé›†ç¾¤ç»Ÿä¸€ç®¡ç†èƒ½åŠ›ã€‚åªéœ€æä¾›éœ€è¦ç®¡ç†é›†ç¾¤çš„ api åœ°å€ï¼Œtoken å’Œ ca è¯ä¹¦ï¼ŒTKEStack å°±å¯ä»¥çº³ç®¡è¯¥é›†ç¾¤ã€‚çº³ç®¡æ“ä½œä¸ä¼šæ±¡æŸ“å¯¼å…¥çš„é›†ç¾¤ï¼Œè¢«çº³ç®¡é›†ç¾¤ä¸ä¼šå¢åŠ é¢å¤–çš„è´Ÿè½½æˆ–é…ç½®ã€‚ç»Ÿä¸€ä¸€è‡´çš„ç”¨æˆ·æƒé™åŠä¸šåŠ¡ç®¡ç†ç­‰åŠŸèƒ½å¸®åŠ©ç”¨æˆ·åœ¨é›†ç¾¤é—´çµæ´»åˆ‡æ¢ï¼Œæ–¹ä¾¿çš„éƒ¨ç½²å’Œç®¡ç†å¤šé›†ç¾¤åº”ç”¨ã€‚</p><img alt=å¤šé›†ç¾¤ç®¡ç† width=100% src=mutil_cluster_management.png><p>æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ<a href=https://tkestack.github.io/docs/user-guide/platform-console/cluster-mgmt.html>é›†ç¾¤ç®¡ç†</a></p><h3 id=å¤šç§Ÿæˆ·ç®¡ç†>å¤šç§Ÿæˆ·ç®¡ç†</h3><p>æ”¯æŒå¤šç§Ÿæˆ·ç®¡ç†å’Œç§Ÿæˆ·é—´éš”ç¦»ï¼Œä¸ä»…ä»…å±€é™äºè´¦å·ï¼Œè€Œæ˜¯åŒ…æ‹¬é›†ç¾¤ã€å‘½åç©ºé—´ã€ä¸šåŠ¡ã€é•œåƒä»“åº“ç­‰ç­‰ï¼Œæ»¡è¶³å¤§ä¸­å‹è§„æ¨¡ä¼ä¸šç®¡ç†çš„éœ€æ±‚ã€‚å¹¶ä¸”åœ¨ç§Ÿæˆ·å±‚æ¬¡ä¹‹ä¸‹ï¼Œæ‹¥æœ‰ä¸šåŠ¡çš„æ¦‚å¿µï¼Œä¸šåŠ¡å¯ä»¥æ¨ªè·¨é›†ç¾¤ï¼Œä¸ºç”¨æˆ·æä¾›ç»Ÿä¸€çš„é…é¢ç®¡ç†ã€å‘½åç©ºé—´ã€ä¸šåŠ¡é…é¢ä»¥åŠé•œåƒä»“åº“å’Œåº”ç”¨å•†åº—ç­‰ç®¡ç†èƒ½åŠ›ï¼Œæ–¹ä¾¿ç”¨æˆ·åœ¨å¤šé›†ç¾¤åœºæ™¯ä¸‹ç¼–æ’ä¸šåŠ¡åº”ç”¨ã€‚</p><img alt=å¤šç§Ÿæˆ·ç®¡ç† width=100% src=mutil_tenant_management.png><p>TKEStackæä¾›ç»Ÿä¸€å’Œå¼€æ”¾çš„è®¤è¯æˆæƒç®¡ç†ï¼Œé€šè¿‡æ‰©å…… kubernetes çš„ authz å’Œ authn çš„ webhookï¼Œå®ç°æ‰€æœ‰é›†ç¾¤æ— éœ€å•ç‹¬é…ç½® RBACï¼Œä¸ºä¸Šå±‚æä¾›ç»Ÿä¸€çš„å¯è·¨é›†ç¾¤çš„èµ„æºæˆæƒã€‚TKEStackè‡ªèº«çš„è®¤è¯å’Œæˆæƒä½“ç³»æ˜¯å®Œæ•´çš„ K8S Style API ä»¥åŠ oidc è®¤è¯åè®®æ”¯æŒï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„ç”±ç¬¬ä¸‰æ–¹é›†æˆå•†æˆ–å¼€å‘è€…é›†æˆåœ¨è‡ªèº«çš„äº§å“ä¸­ï¼Œå®ç°å’Œ TKEStack æ†ç»‘æœåŠ¡ã€‚ä¼ä¸šçº§ç”¨æˆ·å¯ä»¥æ–¹ä¾¿çš„å°†å·²æœ‰çš„è´¦æˆ·ä½“ç³»æˆ–ç»„ç»‡æ¶æ„æ˜ å°„åˆ° TKEStack å¹³å°ä¸­ï¼Œä»è€ŒèŠ‚çœå®¹å™¨å¹³å°å¯¹æ¥çš„å·¥ä½œé‡ï¼Œä¸“æ³¨äºè‡ªèº«é«˜ä»·å€¼ä¸šåŠ¡çš„å¼€å‘ã€‚</p><p>æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ<a href=https://tkestack.github.io/docs/user-guide/platform-console/access-mgmt/>è®¿é—®ç®¡ç†</a></p><h3 id=è¿ç»´å‹å¥½çš„ç®¡ç†å¹³å°>è¿ç»´å‹å¥½çš„ç®¡ç†å¹³å°</h3><p>TKEStack è‡´åŠ›äºæ‰“é€ ä¸€ä¸ªè¿ç»´å‹å¥½çš„ç®¡ç†å¹³å°ï¼Œå¸®åŠ©è¿ç»´äººå‘˜ä»ç¹æ‚çš„åŠ³åŠ¨ä¸­è§£æ”¾å‡ºæ¥ã€‚TKEStack æä¾›å®Œæ•´è¯¦ç»†çš„ç›‘æ§åŠæ—¥å¿—æœåŠ¡ï¼Œç²’åº¦ç²¾ç»†åˆ°å¯¹é›†ç¾¤ä¸‹æ¯ä¸€ä¸ªå®¹å™¨æ¯ä¸€æ¡æ—¥å¿—éƒ½æœ‰ç›‘æ§å’Œè®°å½•ã€‚å¹¶ä¸”æä¾›æ™ºèƒ½åŒ–çš„å®‰è£…å·¥å…·ã€å·¡æ£€å·¥å…·ï¼Œå¸®åŠ©è¿ç»´äººå‘˜å¯¹æ•´ä¸ªå¹³å°å…¨ç¨‹è¿›è¡Œç®¡ç†ï¼Œæå‰å‘ç°é£é™©ç‚¹ï¼Œæé«˜ç³»ç»Ÿçš„å¯é æ€§ã€‚</p><h4 id=å¿«æ·å®‰è£…>å¿«æ·å®‰è£…</h4><p>TKEStack ä½¿ç”¨ tke-installer å®‰è£…å·¥å…·è¿›è¡Œå®‰è£…ï¼Œé€šè¿‡ç•Œé¢åŒ–çš„æ–¹å¼å¼•å¯¼ç”¨æˆ·ä¸€é”®éƒ¨ç½² TKEStack å®¹å™¨å¹³å°ã€‚tke-installer å®‰è£…å·¥å…·èƒ½å¤Ÿæ£€æŸ¥åŸºæœ¬çš„ç¯å¢ƒä¿¡æ¯ï¼Œè‡ªåŠ¨é€‚é… x86 æˆ– arm ç‰ˆæœ¬å®‰è£…é©±åŠ¨å’Œé•œåƒã€‚ç¦»çº¿çš„å®‰è£…æ–¹å¼æ›´å…å»ç”¨æˆ·æ‹‰å–é•œåƒçš„çƒ¦æ¼ï¼Œæå¤§çš„æé«˜äº†å®¹å™¨å¹³å°éƒ¨ç½²çš„æ•ˆç‡ã€‚</p><img alt=å®‰è£…æµç¨‹ width=100% src=install_process.png><p>tke-installer è‡ªåŠ¨ç­‰å¾…å’Œæ£€æŸ¥æ¯ä¸€æ­¥éª¤å®‰è£…å®Œæˆï¼Œå¦‚æœä¸­é—´è¿‡ç¨‹å‡ºé”™ä¼šè‡ªåŠ¨åœ¨æ—¥å¿—ç•Œé¢æç¤ºç›¸åº”çš„ä¿¡æ¯ï¼Œå¹¶æ”¯æŒæ ¹æ®ç”¨æˆ·éœ€è¦ï¼Œé€‰æ‹©å…¨æ–°å®‰è£…æˆ–ä»å¤±è´¥æ­¥éª¤ç»§ç»­å®‰è£…ã€‚æ›´æ”¯æŒä»¥ hook æ–¹å¼è‡ªå®šä¹‰å®‰è£…æµç¨‹ï¼Œç”¨æˆ·å¯ä»¥åœ¨å®‰è£…å¼€å§‹å‰ã€é›†ç¾¤ ready åä»¥åŠå®‰è£…ç»“æŸåä¸‰ä¸ª hook ç‚¹æ·»åŠ è‡ªå·±çš„è„šæœ¬æˆ–å‘½ä»¤ï¼Œå®ç°å¹³å°å®‰è£…çš„å¯å®šåˆ¶åŒ–ã€‚</p><p>æ›´å¤šå®‰è£…ä¿¡æ¯è¯·è§ï¼š<a href=https://github.com/tkestack/tke/tree/master/docs/guide/zh-CN/installation>TKEStackå®‰è£…è¯´æ˜</a></p><h4 id=ç›‘æ§ç³»ç»Ÿ>ç›‘æ§ç³»ç»Ÿ</h4><p>å…å»éƒ¨ç½²å’Œé…ç½® prometheus çš„å¤æ‚æ“ä½œï¼ŒTKEStack æä¾›é«˜å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§çš„ç»†ç²’åº¦ç›‘æ§ç³»ç»Ÿï¼Œå®æ—¶ç›‘æ§ CPUï¼ŒGPUï¼Œå†…å­˜ï¼Œæ˜¾å­˜ï¼Œç½‘ç»œå¸¦å®½ï¼Œç£ç›˜ioç­‰å¤šç§æŒ‡æ ‡å¹¶è‡ªåŠ¨ç»˜åˆ¶è¶‹åŠ¿æ›²çº¿ï¼Œå¸®åŠ©è¿ç»´äººå‘˜å…¨ç»´åº¦çš„æŒæ¡å¹³å°è¿è¡ŒçŠ¶æ€ã€‚</p><img alt=ç›‘æ§ç³»ç»Ÿ width=100% src=monitor.png><p>TKEStacké€šè¿‡prometheusç»„ä»¶ç›‘æ§é›†ç¾¤çŠ¶æ€ï¼Œprometheus ç»„ä»¶é€šè¿‡ addon æ‰©å±•ç»„ä»¶è‡ªåŠ¨å®Œæˆå®‰è£…å’Œé…ç½®ï¼Œä½¿ç”¨ influxdbï¼Œelasticsearch ç­‰å­˜å‚¨ç›‘æ§æ•°æ®ã€‚ç›‘æ§æ•°æ®å’ŒæŒ‡æ ‡èå…¥åˆ°å¹³å°ç•Œé¢ä¸­ä»¥é£æ ¼ç»Ÿä¸€å›¾è¡¨çš„é£æ ¼å±•ç¤ºï¼Œæ”¯æŒä»¥ä¸åŒæ—¶é—´ï¼Œç²’åº¦ç­‰æ¡ä»¶ï¼ŒæŸ¥è¯¢é›†ç¾¤ï¼ŒèŠ‚ç‚¹ï¼Œä¸šåŠ¡ï¼Œworkloadä»¥åŠå®¹å™¨ç­‰å¤šä¸ªå±‚çº§çš„ç›‘æ§æ•°æ®ï¼Œå…¨ç»´åº¦çš„æŒæ¡å¹³å°è¿è¡ŒçŠ¶æ€ã€‚</p><p>åŒæ—¶é’ˆå¯¹åœ¨å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§æ–¹é¢ï¼Œæ”¯æŒä½¿ç”¨ thanos æ¶æ„æä¾›å¯é çš„ç»†ç²’åº¦ç›‘æ§å’Œè­¦æŠ¥æœåŠ¡ï¼Œæ„å»ºå…·æœ‰é«˜å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§çš„ç»†ç²’åº¦ç›‘æ§èƒ½åŠ›ã€‚</p><p>è¯¦æƒ…è¯·è§<a href=https://mp.weixin.qq.com/s/Kn4RACzihWGoajV1Q0G_cA>thanosæ¶æ„ä»‹ç»</a></p><h4 id=æ—¥å¿—æœåŠ¡>æ—¥å¿—æœåŠ¡</h4><p>æä¾›çš„é›†ç¾¤å†…æ—¥å¿—é‡‡é›†åŠŸèƒ½ï¼Œæ”¯æŒå°†é›†ç¾¤å†…æœåŠ¡æˆ–é›†ç¾¤èŠ‚ç‚¹ç‰¹å®šè·¯å¾„æ–‡ä»¶çš„æ—¥å¿—å‘é€è‡³ Kafkaã€Elasticsearchç­‰æ¶ˆè´¹ç«¯ï¼Œæ”¯æŒé‡‡é›†å®¹å™¨æ ‡å‡†è¾“å‡ºæ—¥å¿—ï¼Œå®¹å™¨å†…æ–‡ä»¶æ—¥å¿—ä»¥åŠä¸»æœºå†…æ–‡ä»¶æ—¥å¿—ã€‚æ›´æä¾›äº‹ä»¶æŒä¹…åŒ–ã€å®¡è®¡ç­‰åŠŸèƒ½ï¼Œå®æ—¶è®°å½•é›†ç¾¤äº‹ä»¶åŠæ“ä½œæ—¥å¿—è®°å½•ï¼Œå¸®åŠ©è¿ç»´äººå‘˜å­˜å‚¨å’Œåˆ†æé›†ç¾¤å†…éƒ¨èµ„æºç”Ÿå‘½å‘¨æœŸã€èµ„æºè°ƒåº¦ã€å¼‚å¸¸å‘Šè­¦ç­‰æƒ…å†µã€‚</p><img alt=æ—¥å¿—æœåŠ¡ width=100% src=log.png><p>éœ€è¦ä¸ºæ¯ä¸ªé›†ç¾¤æ‰‹åŠ¨å¼€å¯æ—¥å¿—é‡‡é›†åŠŸèƒ½ã€‚æ—¥å¿—é‡‡é›†åŠŸèƒ½å¼€å¯åï¼Œlog-collector ä¼šåœ¨é›†ç¾¤å†…ä»¥ DaemonSet çš„å½¢å¼è¿è¡Œï¼Œå¹¶æ ¹æ®ç”¨æˆ·é€šè¿‡æ—¥å¿—é‡‡é›†è§„åˆ™é…ç½®çš„é‡‡é›†æºå’Œæ¶ˆè´¹ç«¯ï¼Œä»é‡‡é›†æºè¿›è¡Œæ—¥å¿—é‡‡é›†ï¼Œå°†æ—¥å¿—å†…å®¹å‘é€åˆ°æ¶ˆè´¹ç«¯ã€‚</p><ul><li>é‡‡é›†å®¹å™¨æ ‡å‡†è¾“å‡ºæ—¥å¿— - é‡‡é›†é›†ç¾¤å†…æŒ‡å®šå®¹å™¨çš„æ ‡å‡†è¾“å‡ºæ—¥å¿—ï¼Œé‡‡é›†åˆ°çš„æ—¥å¿—ä¿¡æ¯å°†ä¼šä»¥ JSON æ ¼å¼è¾“å‡ºåˆ°ç”¨æˆ·æŒ‡å®šçš„æ¶ˆè´¹ç«¯ï¼Œå¹¶ä¼šè‡ªåŠ¨é™„åŠ ç›¸å…³çš„ Kubernetes metadataï¼Œ åŒ…æ‹¬å®¹å™¨æ‰€å± pod çš„ label å’Œ annotation ç­‰ä¿¡æ¯ã€‚</li><li>é‡‡é›†å®¹å™¨å†…æ–‡ä»¶æ—¥å¿— - é‡‡é›†é›†ç¾¤å†…æŒ‡å®š pod å†…æ–‡ä»¶çš„æ—¥å¿—ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œçµæ´»çš„é…ç½®æ‰€éœ€çš„å®¹å™¨å’Œè·¯å¾„ï¼Œé‡‡é›†åˆ°çš„æ—¥å¿—ä¿¡æ¯å°†ä¼šä»¥ JSON æ ¼å¼è¾“å‡ºåˆ°ç”¨æˆ·æŒ‡å®šçš„æ¶ˆè´¹ç«¯ï¼Œ å¹¶ä¼šé™„åŠ ç›¸å…³çš„ Kubernetes metadataï¼ŒåŒ…æ‹¬å®¹å™¨æ‰€å± pod çš„ label å’Œ annotation ç­‰ä¿¡æ¯ã€‚</li><li>é‡‡é›†ä¸»æœºå†…æ–‡ä»¶æ—¥å¿— - é‡‡é›†é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹çš„æŒ‡å®šä¸»æœºè·¯å¾„çš„æ—¥å¿—ï¼Œlog-collector ä¼šé‡‡é›†é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ»¡è¶³æŒ‡å®šè·¯å¾„è§„åˆ™çš„æ–‡ä»¶æ—¥å¿—ï¼Œä»¥ JSON æ ¼å¼è¾“å‡ºåˆ°ç”¨æˆ·æŒ‡å®šçš„è¾“å‡ºç«¯ï¼Œ å¹¶ä¼šé™„åŠ ç”¨æˆ·æŒ‡å®šçš„ metadataï¼ŒåŒ…æ‹¬æ—¥å¿—æ¥æºæ–‡ä»¶çš„è·¯å¾„å’Œç”¨æˆ·è‡ªå®šä¹‰çš„ metadataã€‚</li></ul><p>æ›´å¤šæ—¥å¿—ä¿¡æ¯è¯·å‚è€ƒ<a href=https://tkestack.github.io/docs/user-guide/platform-console/operation-mgmt/log-collect.html>æ—¥å¿—ç®¡ç†</a></p><h4 id=å¹³å°å·¡æ£€>å¹³å°å·¡æ£€</h4><p>å·¡æ£€å·¥å…· kube-javisï¼Œé€šè¿‡ plugin æ’ä»¶çš„æ–¹å¼çµæ´»é…ç½®å’Œæ‰©å±•ï¼Œå¤šç»´åº¦çš„æ£€æŸ¥ TKEStack å¹³å°ä¸‹é›†ç¾¤çš„å¥åº·çŠ¶å†µï¼Œæ”¯æŒé›†æˆåˆ° TKEStack å¹³å°ä¸­ï¼Œå®šæœŸè¿è¡Œå¹¶è¾“å‡ºè¯Šæ–­ç»“æœå’Œä¿®å¤å»ºè®®ã€‚</p><p>æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å…³æ³¨<a href=https://github.com/tkestack/kube-jarvis>kube-javis</a></p><h3 id=æ‰©å±•ç»„ä»¶æ”¯æŒå’Œç®¡ç†>æ‰©å±•ç»„ä»¶æ”¯æŒå’Œç®¡ç†</h3><p>Tkestack çš„ç‰¹è‰²åŠŸèƒ½ï¼Œä»¥æ‰©å±•ç»„ä»¶çš„æ–¹å¼æ¥è®¢åˆ¶é›†ç¾¤çš„èƒ½åŠ›ï¼Œæ‰©å±•é›†ç¾¤çš„åŠŸèƒ½ã€‚TKEStack å·²æ”¯æŒå¤šç§æ‰©å±•ç»„ä»¶ï¼ŒåŒ…å«ï¼š</p><ul><li>GPUManager - GPU Manager æä¾›ä¸€ä¸ª All-in-One çš„ GPU ç®¡ç†å™¨, åŸºäºK8S Device Pluginæ’ä»¶ç³»ç»Ÿå®ç°, æä¾›äº† GPU è™šæ‹ŸåŒ–ã€æ‹“æ‰‘åˆ†é…ã€GPU å…±äº«ã€GPU æŒ‡æ ‡æŸ¥è¯¢ã€GPU å®¹å™¨ pre-check ç­‰åŠŸèƒ½, æ”¯æŒç”¨æˆ·åœ¨ K8S é›†ç¾¤ä¸­é«˜æ•ˆçš„ä½¿ç”¨ GPU è®¾å¤‡ã€‚</li><li>TApp - Tapp æ˜¯ç»“åˆè…¾è®¯åå¤šå¹´æµ·é‡è¿è¥ç»éªŒï¼Œå…¨æ–°è®¾è®¡å‡ºçš„ä¸€ç§ workloadï¼Œä»¥ CRD çš„å½¢å¼å®ç°ã€‚ Tappå¯è¿è¡Œæœ‰çŠ¶æ€ã€æ— çŠ¶æ€åº”ç”¨ï¼Œå¼¥è¡¥äº† StatefulSet æ— æ³•æ‰¹é‡æ›´æ–°å®¹å™¨çš„ä¸è¶³ï¼Œä½¿ç”¨æ–¹å¼å…¼å®¹ä¼ ç»Ÿè¿ç»´ä¹ æƒ¯ï¼Œæ›´å¥½çš„æ”¯æŒä¼ ç»Ÿçš„æœ‰çŠ¶æ€åº”ç”¨ï¼Œèƒ½å¤Ÿå®ç°ç°åº¦å‡çº§å’Œå¤šç‰ˆæœ¬çš„å‘å¸ƒç®¡ç†ã€‚</li><li>CronHPA - ä½¿ç”¨ crontab æ¨¡å¼å®šæœŸè‡ªåŠ¨æ‰©å®¹å·¥ä½œè´Ÿè½½ï¼Œå‘¨æœŸæ€§åœ°åœ¨ç»™å®šçš„è°ƒåº¦æ—¶é—´å¯¹å·¥ä½œè´Ÿè½½è¿›è¡Œæ‰©ç¼©å®¹ã€‚</li><li>LBCF - ä¸€æ¬¾é€šç”¨è´Ÿè½½å‡è¡¡æ§åˆ¶é¢æ¡†æ¶ï¼Œå¯¹K8Så†…éƒ¨æ™¦æ¶©çš„è¿è¡Œæœºåˆ¶è¿›è¡Œäº†å°è£…å¹¶ä»¥ Webhook çš„å½¢å¼å¯¹å¤–æš´éœ²ï¼Œå¹¶æä¾›å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›ä»¥æ»¡è¶³ä¸šåŠ¡æ–¹åœ¨ä½¿ç”¨è´Ÿè½½å‡è¡¡æ—¶çš„ä¸ªæ€§åŒ–éœ€æ±‚ã€‚</li><li>CSIOperator - è´Ÿè´£ CSI ç›¸å…³ç»„ä»¶çš„éƒ¨ç½²ä¸ç»´æŠ¤ï¼Œå¸®åŠ©ç”¨æˆ·åœ¨é›†ç¾¤ä¸­ä½¿ç”¨å­˜å‚¨ã€‚</li><li>IPAM - é€šè¿‡ IPAM æ‰©å±•ç»„ä»¶å®‰è£…ï¼Œæ‰©å±•äº† K8S è°ƒåº¦æ’ä»¶ï¼Œå®ç° Float IP çš„é…ç½®å’Œç®¡ç†ï¼Œæ»¡è¶³å¤æ‚åº”ç”¨å®¹å™¨åŒ–çš„ç‰¹æ®Šéœ€æ±‚ã€‚</li></ul><p>æ›´å¤šè¯¦æƒ…è¯·å‚è€ƒ<a href=https://tkestack.github.io/docs/key-features/>æ‰©å±•ç»„ä»¶</a></p><h2 id=æ€»ç»“>æ€»ç»“</h2><p>éšç€2020å¹´3æœˆå›½å®¶å‘æ”¹å§”è¿›ä¸€æ­¥æ˜ç¡®äº†åŒ…æ‹¬ä»¥äº‘è®¡ç®—ç­‰ä¸ºä»£è¡¨çš„æ–°æŠ€æœ¯åŸºç¡€è®¾æ–½çº³å…¥â€œæ–°åŸºå»ºâ€çš„èŒƒå›´ï¼Œå›½å†…äº‘è®¡ç®—å¸‚åœºå°†è¿æ¥ä¸€æ³¢å»ºè®¾çš„çƒ­æ½®ã€‚å°¤å…¶åœ¨ç§æœ‰äº‘é¢†åŸŸï¼Œä¼ ç»Ÿè¡Œä¸šä¼ä¸šåŸºæœ¬å¼€å§‹äº†ä¸šåŠ¡çš„äº‘è¿ç§»ï¼Œä½†å…¶åº”ç”¨ç³»ç»Ÿçš„å¼¹æ€§ã€è‡ªåŠ¨åŒ–è¿ç»´ç®¡ç†èƒ½åŠ›ä»¥åŠ Devops å’ŒæŒç»­äº¤ä»˜çš„èƒ½åŠ›ä»åœ¨ä¸æ–­çš„æ¢ç´¢å’Œå°è¯•ï¼Œè¿«åˆ‡çš„éœ€è¦ä¸€å¥—æˆç†Ÿçš„äº§å“å¹³å°å’Œç”Ÿæ€ä½“ç³»ï¼Œå¸®åŠ©ä¼ä¸šå®Œæˆäº‘åŸç”Ÿè½¬å‹ã€‚</p><p>å¼€æºTKEStackçš„æ¨å‡ºï¼Œå°†æ¨åŠ¨ä¼ä¸šä¸šåŠ¡å‘äº‘åŸç”Ÿçš„è½¬å‹ï¼Œæä¾›å®Œå–„çš„å®¹å™¨äº§å“åŠŸèƒ½ï¼Œæ‰“é€ è¿ç»´å‹å¥½çš„ç®¡ç†å¹³å°ï¼Œå‡å°‘ç”¨æˆ·ç¹å¤çš„åŠ³åŠ¨ï¼Œæé«˜å·¥ä½œæ•ˆç‡ã€‚å®Œå–„çš„APIå’Œç§Ÿæˆ·ç®¡ç†èƒ½åŠ›ï¼Œæ–¹ä¾¿ç”¨æˆ·å°†å·²æœ‰çš„è´¦æˆ·ä½“ç³»æˆ–ç»„ç»‡æ¶æ„æ˜ å°„åˆ°TKEStackå¹³å°ä¸­ï¼ŒèŠ‚çœå¹³å°ä¸šåŠ¡å¯¹æ¥çš„å·¥ä½œé‡ã€‚å¹¶ä¸”è‰¯å¥½çš„æ‰©å±•èƒ½åŠ›ä½¿å¾—ç”¨æˆ·èƒ½å¤ŸåŸºäº TKEStack é€‚é…æœ¬åœ°åŸºç¡€è®¾æ–½ï¼Œæ‰©å±•ä¸šåŠ¡æ‰€éœ€çš„å„ç§èƒ½åŠ›ã€‚</p><p>TKEStack å·²åœ¨è…¾è®¯å†…éƒ¨å¤§é‡ä½¿ç”¨ï¼Œæ€»ç»“ç§¯ç´¯äº†å¤§é‡ç»éªŒå’ŒæŠ€æœ¯ï¼ŒæŒç»­è¿›è¡Œè¿­ä»£å¼€å‘ï¼Œä¸æ–­å®Œå–„åŠŸèƒ½ç‰¹æ€§ï¼Œå¹¶ä¸”ç¬¬ä¸€æ—¶é—´å°†æˆæœè´¡çŒ®ç»™ç¤¾åŒºï¼Œå¸®åŠ©ç”¨æˆ·ç´§è·Ÿäº‘åŸç”Ÿæ½®æµï¼Œäº«ç”¨æœ€æ–°æŠ€æœ¯èƒ½åŠ›ï¼ŒåŒæ—¶å…é™¤äº†è¢«æŠ€æœ¯ç»‘å®šçš„é£é™©ã€‚æˆ‘ä»¬å¸Œæœ›é€šè¿‡ TKEStack çš„ç¨³å®šé«˜æ•ˆå’Œçµæ´»æ‰©å±•çš„å¹³å°èƒ½åŠ›ï¼Œå¸®åŠ©æ‚¨æ„å»ºä»¥ TKEStack ä¸ºåº•åº§çš„ï¼Œé€‚é…å„ç§ç¡¬ä»¶æ¶æ„å’ŒåŸºç¡€ç¯å¢ƒçš„ï¼Œé¢å‘ AIã€å¤§æ•°æ®ã€ä¸­é—´ä»¶ä»¥åŠå¾®æœåŠ¡ç­‰ç­‰å¤šç§åœºæ™¯çš„æœåŠ¡ï¼Œåœ¨äº’è”ç½‘ã€ä¼ ç»Ÿè¡Œä¸šä¸æ”¿ä¼ç­‰é¢†åŸŸï¼Œè”åˆåˆä½œä¼™ä¼´æä¾›æœ‰é’ˆå¯¹æ€§çš„è¡Œä¸šè§£å†³æ–¹æ¡ˆã€‚TKEStack ä»åœ¨ä¸æ–­çš„æˆé•¿ä¸­ï¼Œåç»­æˆ‘ä»¬è¿˜ä¼šå¼€å‘æ›´å¤šçš„åŠŸèƒ½ï¼Œè¾“å‡ºæ›´å¤šè…¾è®¯å†…éƒ¨ä¼˜ç§€çš„äº§å“å’Œèƒ½åŠ›ã€‚</p><p>æœ€åï¼Œæ„Ÿè°¢æ‚¨çš„æ—¶é—´ï¼Œå¸Œæœ›ä½ åœ¨è¯»å®Œæ–‡ç« åï¼Œèƒ½å¤Ÿäº†è§£åˆ° TKEStack å®¹å™¨äº‘å¹³å°ï¼Œå¸Œæœ› TKEStack èƒ½å¤Ÿæˆä¸ºæ‚¨çš„é€‰æ‹©ï¼Œ æˆ‘ä»¬æ„¿ä¸æ‚¨ä¸€é“å‰è¡Œï¼Œåˆ›é€ ä»·å€¼ï¼ŒåŠ é€Ÿåˆ›æ–°ï¼Œå…±å»ºäº‘ç”Ÿæ€ï¼Œä¸€èµ·è¿ˆå‘æœªæ¥äº‘ä¸–ç•Œã€‚</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/tkestack/tke aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 The TKEStack Authors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/web/js/main.min.1911ee3ae98d7d6df3807cd00d8e31ae7d1c08ee0f0bb587529b0483da4e5464.js integrity="sha256-GRHuOumNfW3zgHzQDY4xrn0cCO4PC7WHUpsEg9pOVGQ=" crossorigin=anonymous></script></body></html>